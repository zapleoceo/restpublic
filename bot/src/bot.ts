import { Telegraf, Markup } from 'telegraf';
import dotenv from 'dotenv';
import { menuHandler } from './handlers/menuHandler.js';

// Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
dotenv.config();

const bot = new Telegraf(process.env.TELEGRAM_BOT_TOKEN!);

// ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ¾Ð¼Ð°Ð½Ð´ Ð±Ð¾Ñ‚Ð° (ÑƒÐ±Ð¸Ñ€Ð°ÐµÐ¼ /menu)
bot.telegram.setMyCommands([
  { command: 'start', description: 'ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð±Ð¾Ñ‚Ð°' },
  { command: 'categories', description: 'ðŸ“‹ ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ð±Ð»ÑŽÐ´' },
  { command: 'help', description: 'â“ ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ' }
]);

// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½ÑƒÑŽ ÐºÐ»Ð°Ð²Ð¸Ð°Ñ‚ÑƒÑ€Ñƒ Ñ Ñ‚Ñ€ÐµÐ¼Ñ ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼Ð¸
const mainKeyboard = Markup.keyboard([
  ['ðŸ½ï¸ ÐœÐµÐ½ÑŽ', 'ðŸ“‹ ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸'],
  ['ðŸ“ž ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹']
]).resize();

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.command('start', async (ctx) => {
  // Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ chat_id Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ SePay
  console.log(`ðŸ†” Chat ID: ${ctx.chat.id}, Username: @${ctx.chat.username || 'N/A'}, Name: ${ctx.chat.first_name || ''} ${ctx.chat.last_name || ''}`);
  
  await ctx.reply(
    'ðŸœ Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² RestPublic!\n\nÐ˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð½Ð¸Ð¶Ðµ Ð´Ð»Ñ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸:',
    mainKeyboard
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /categories
bot.command('categories', async (ctx) => {
  await menuHandler.showMainMenu(ctx);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /help
bot.command('help', async (ctx) => {
  const helpMessage = 
    'ðŸ¤– *ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ Ð¿Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÑŽ Ð±Ð¾Ñ‚Ð°*\n\n' +
    'ðŸ½ï¸ *ÐœÐµÐ½ÑŽ* - Ð¿Ð¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð²ÑÐµ Ð±Ð»ÑŽÐ´Ð°\n' +
    'ðŸ“‹ *ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸* - Ð²Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑŽ Ð±Ð»ÑŽÐ´\n' +
    'ðŸ“ž *ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹* - Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ€ÐµÑÑ‚Ð¾Ñ€Ð°Ð½Ðµ\n' +
    'â“ *ÐŸÐ¾Ð¼Ð¾Ñ‰ÑŒ* - ÑÑ‚Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ\n\n' +
    'Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð²Ð½Ð¸Ð·Ñƒ ÑÐºÑ€Ð°Ð½Ð° Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð¹ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸!';

  await ctx.reply(helpMessage, { parse_mode: 'Markdown' });
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ (Ð²ÑÑ‚Ñ€Ð¾ÐµÐ½Ð½Ñ‹Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸)
bot.hears('ðŸ½ï¸ ÐœÐµÐ½ÑŽ', async (ctx) => {
  await menuHandler.showAllProducts(ctx);
});

bot.hears('ðŸ“‹ ÐšÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸', async (ctx) => {
  await menuHandler.showMainMenu(ctx);
});

bot.hears('ðŸ“ž ÐšÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹', async (ctx) => {
  await menuHandler.showContact(ctx);
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð²ÑÐµÑ… Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', async (ctx) => {
  // Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð»Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼ chat_id Ð´Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ SePay
  console.log(`ðŸ†” Chat ID: ${ctx.chat.id}, Username: @${ctx.chat.username || 'N/A'}, Name: ${ctx.chat.first_name || ''} ${ctx.chat.last_name || ''}, Text: ${ctx.message.text}`);
  
  await ctx.reply(
    'Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð²Ð½Ð¸Ð·Ñƒ ÑÐºÑ€Ð°Ð½Ð° Ð´Ð»Ñ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸ Ð¸Ð»Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ /help Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÐ¿Ñ€Ð°Ð²ÐºÐ¸.',
    mainKeyboard
  );
});

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.catch((err, ctx) => {
  console.error(`Error for ${ctx.updateType}:`, err);
  ctx.reply('âŒ ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.');
});

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð¾Ñ‚Ð°
async function startBot() {
  try {
    console.log('ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Telegram Ð±Ð¾Ñ‚Ð°...');
    await bot.launch();
    console.log('âœ… Ð‘Ð¾Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!');
  } catch (error) {
    console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð±Ð¾Ñ‚Ð°:', error);
    process.exit(1);
  }
}

// Graceful stop
process.once('SIGINT', () => bot.stop('SIGINT'));
process.once('SIGTERM', () => bot.stop('SIGTERM'));

startBot();
