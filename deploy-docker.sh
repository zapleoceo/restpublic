#!/bin/bash

# North Republic Docker Deployment Script v1.0
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–¥ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º Docker –¥–µ–ø–ª–æ–π North Republic v1.0 (Production)..."

cd /var/www/northrepubli_usr/data/www/northrepublic.me
echo "üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Git –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
echo "üîß –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git..."
git config --local core.editor /bin/true
git config --local merge.tool /bin/true
export GIT_EDITOR=/bin/true
export EDITOR=/bin/true

echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
# –ò—Å–ø–æ–ª—å–∑—É–µ–º --allow-unrelated-histories –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—á–∏—â–µ–Ω–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π
git pull origin main --allow-unrelated-histories --no-edit || {
    echo "‚ö†Ô∏è –û–±—ã—á–Ω—ã–π pull –Ω–µ —É–¥–∞–ª—Å—è, –≤—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π reset..."
    git fetch origin
    git reset --hard origin/main
}

echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pm2 stop all || echo "PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
pm2 delete all || echo "PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"

echo "üê≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º Docker..."
if ! command -v docker &> /dev/null; then
    echo "‚ùå Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

echo "üîß –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä..."
# –ò—Å–ø–æ–ª—å–∑—É–µ–º sudo –¥–ª—è Docker –∫–æ–º–∞–Ω–¥
sudo docker compose down || echo "–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã"
sudo docker compose build --no-cache
sudo docker compose up -d

echo "‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
if sudo docker compose ps | grep -q "Up"; then
    echo "‚úÖ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω—ã"
else
    echo "‚ùå –û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã"
    echo "üìã –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
    sudo docker compose logs
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint..."
if curl -f http://localhost:3002/api/health; then
    echo "‚úÖ Backend API —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    echo "‚ùå Backend API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
    echo "üìã –õ–æ–≥–∏ backend –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
    sudo docker compose logs northrepublic
    exit 1
fi

echo "üéâ Docker –¥–µ–ø–ª–æ–π North Republic –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://northrepublic.me"
echo "üì° Backend API: http://localhost:3002/api/health"
echo "üìã –õ–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: sudo docker compose logs"
echo "üîç –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: sudo docker compose ps"
