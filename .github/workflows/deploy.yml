name: Deploy to Server

on:
  push:
    branches: [ dev ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Debug secrets
      run: |
        echo "Checking if secrets are available..."
        if [ -n "${{ secrets.SSH_HOST }}" ]; then
          echo "‚úÖ SSH_HOST is set"
        else
          echo "‚ùå SSH_HOST is missing"
          exit 1
        fi
        
        if [ -n "${{ secrets.SSH_USER }}" ]; then
          echo "‚úÖ SSH_USER is set"
        else
          echo "‚ùå SSH_USER is missing"
          exit 1
        fi
        
        if [ -n "${{ secrets.SSH_KEY }}" ]; then
          echo "‚úÖ SSH_KEY is set"
        else
          echo "‚ùå SSH_KEY is missing"
          exit 1
        fi
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 60m
        script: |
          cd /var/www/goodzone_zap_usr/data/www/goodzone.zapleo.com
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π..."
          echo "üìÖ –í—Ä–µ–º—è: $(date)"
          echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º Git —Å—Ç–∞—Ç—É—Å..."
          git status
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç
          chmod +x deploy.sh
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          ./deploy.sh
          
          echo "‚úÖ –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          
    - name: Health check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 10m
        script: |
          echo "üîç –í—ã–ø–æ–ª–Ω—è–µ–º health check..."
          sleep 15
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º backend
          echo "üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º backend API..."
          curl -f http://localhost:3001/api/health || {
            echo "‚ùå Backend health check failed"
            echo "üìã –õ–æ–≥–∏ backend:"
            tail -n 20 /var/www/goodzone_zap_usr/data/www/goodzone.zapleo.com/logs/backend.log
            exit 1
          }
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã..."
          pm2 list
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º frontend
          echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º frontend..."
          curl -f https://goodzone.zapleo.com/m > /dev/null || {
            echo "‚ùå Frontend check failed"
            exit 1
          }
          
          echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
