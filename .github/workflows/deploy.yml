name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'backend/package-lock.json'
        
    - name: Install Backend Dependencies
      run: |
        cd backend
        npm install
        
    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment to production..."
          
          # Navigate to project directory
          PROJECT_DIR="/var/www/northrepubli_usr/data/www/northrepublic.me"
          cd $PROJECT_DIR
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes from Git..."
          git fetch origin
          git reset --hard origin/main
          git clean -fd
          
          # Install backend dependencies
          echo "ğŸ“¦ Installing backend dependencies..."
          cd backend
          npm install
          
          # Install PHP dependencies
          echo "ğŸ“¦ Installing PHP dependencies..."
          cd ..
          composer install --no-dev --optimize-autoloader
          
          # Copy PHP files to root
          echo "ğŸ“ Copying PHP files to root..."
          cp php/index.php .
          cp php/menu.php .
          cp -r php/components .
          
          # Copy template files
          echo "ğŸ“ Copying template files..."
          cp -r template/css .
          cp -r template/js .
          cp -r template/images .
          cp template/*.png .
          cp template/*.ico .
          
          # Restart backend with PM2
          echo "ğŸ”„ Restarting backend service..."
          pm2 restart northrepublic-backend || pm2 start backend/server.js --name northrepublic-backend
          pm2 save
          
          # Initialize menu cache
          echo "ğŸ”„ Initializing menu cache..."
          php php/init-cache.php || echo "âš ï¸ Cache initialization failed"
          
          # Check services status
          echo "ğŸ“Š Checking services status..."
          pm2 list
          
          # Health check
          echo "ğŸ¥ Performing health check..."
          sleep 10
          curl -f http://localhost:3002/api/health || echo "âŒ Backend health check failed"
          
          echo "âœ… Deployment completed successfully!"
          
    - name: Health Check
      run: |
        echo "ğŸ¥ Final health check..."
        sleep 30
        curl -f https://northrepublic.me/api/health || echo "âŒ Production health check failed"