name: Deploy to Production

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm ci --legacy-peer-deps
        
    - name: Build Frontend
      run: |
        cd frontend
        npm run build
        
    - name: Install Backend Dependencies
      run: |
        cd backend
        npm install
        
    - name: Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        script: |
          echo "ğŸš€ Starting deployment to production..."
          
          # Navigate to project directory
          cd /var/www/northrepubli_usr/data/www/northrepublic.me
          
          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes from Git..."
          git reset --hard origin/main
          git clean -fd
          
          # Install backend dependencies
          echo "ğŸ“¦ Installing backend dependencies..."
          cd backend
          npm install
          
          # Configure Poster API token
          echo "ğŸ”§ Configuring Poster API token..."
          sed -i 's/your_poster_api_token_here/${{ secrets.POSTER_API_TOKEN }}/' config.env
          
          # Restart backend with PM2
          echo "ğŸ”„ Restarting backend service..."
          pm2 stop northrepublic-backend || true
          pm2 delete northrepublic-backend || true
          pm2 start server.js --name northrepublic-backend
          pm2 save
          
          # Install frontend dependencies
          echo "ğŸ“¦ Installing frontend dependencies..."
          cd ../frontend
          npm ci --legacy-peer-deps
          
          # Build frontend
          echo "ğŸ”¨ Building frontend..."
          npm run build
          
          # Copy built files to public directory
          echo "ğŸ“ Copying built files..."
          cp -r build/* ../
          
          # Check services status
          echo "ğŸ“Š Checking services status..."
          pm2 list
          
          # Health check
          echo "ğŸ¥ Performing health check..."
          sleep 10
          curl -f http://localhost:3002/api/health || echo "âŒ Backend health check failed"
          
          echo "âœ… Deployment completed successfully!"
          
    - name: Health Check
      run: |
        echo "ğŸ¥ Final health check..."
        sleep 30
        curl -f https://northrepublic.me/api/health || echo "âŒ Production health check failed"
