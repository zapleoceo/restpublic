# Updated: 2025-08-31 - Improved deployment workflow
name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Debug secrets
      run: |
        echo "Checking if secrets are available..."
        if [ -n "${{ secrets.PRODUCTION_HOST }}" ]; then
          echo "‚úÖ PRODUCTION_HOST is set"
        else
          echo "‚ùå PRODUCTION_HOST is missing"
          exit 1
        fi
        
        if [ -n "${{ secrets.PRODUCTION_USER }}" ]; then
          echo "‚úÖ PRODUCTION_USER is set"
        else
          echo "‚ùå PRODUCTION_USER is missing"
          exit 1
        fi
        
        if [ -n "${{ secrets.PRODUCTION_SSH_KEY }}" ]; then
          echo "‚úÖ PRODUCTION_SSH_KEY is set"
        else
          echo "‚ùå PRODUCTION_SSH_KEY is missing"
          exit 1
        fi
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 60m
        script: |
          cd /var/www/northrepubli_usr/data/www/northrepublic.me
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π Production v5.2..."
          echo "üìÖ –í—Ä–µ–º—è: $(date)"
          echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º Git —Å—Ç–∞—Ç—É—Å..."
          git status
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç
          chmod +x deploy.sh
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          ./deploy.sh
          
          echo "‚úÖ –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π Production v5.2 –∑–∞–≤–µ—Ä—à–µ–Ω!"
          
    - name: Health check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 10m
        script: |
          echo "üîç –í—ã–ø–æ–ª–Ω—è–µ–º health check..."
          sleep 20
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã..."
          pm2 list
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º backend
          echo "üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º backend API..."
          for i in {1..5}; do
            echo "–ü–æ–ø—ã—Ç–∫–∞ $i –∏–∑ 5..."
            if curl -f http://localhost:3002/api/health; then
              echo "‚úÖ Backend —Ä–∞–±–æ—Ç–∞–µ—Ç!"
              break
            else
              echo "‚ùå –ü–æ–ø—ã—Ç–∫–∞ $i –Ω–µ —É–¥–∞–ª–∞—Å—å"
              if [ $i -eq 5 ]; then
                echo "‚ùå Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫"
                echo "üìã –õ–æ–≥–∏ PM2:"
                pm2 logs northrepublic-backend --lines 10 || echo "‚ùå PM2 –ª–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
                exit 1
              fi
              sleep 5
            fi
          done
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º MongoDB —á–µ—Ä–µ–∑ health endpoint
          echo "üîó –ü—Ä–æ–≤–µ—Ä—è–µ–º MongoDB..."
          health_response=$(curl -s http://localhost:3002/api/health)
          if echo "$health_response" | grep -q '"mongodb":"connected"'; then
            echo "‚úÖ MongoDB –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!"
          else
            echo "‚ùå MongoDB –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞"
            echo "–û—Ç–≤–µ—Ç health endpoint: $health_response"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º frontend
          echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º frontend..."
          if curl -f https://northrepublic.me | grep -q "North Republic"; then
            echo "‚úÖ Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç!"
          else
            echo "‚ùå Frontend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"
            exit 1
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º bot —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π rate limiting –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
          echo "ü§ñ –ü—Ä–æ–≤–µ—Ä—è–µ–º Telegram bot..."
          bot_status=$(pm2 list | grep northrepublic-bot | awk '{print $10}')
          if [ "$bot_status" = "online" ]; then
            echo "‚úÖ Bot —Ä–∞–±–æ—Ç–∞–µ—Ç!"
          else
            echo "‚ö†Ô∏è Bot –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏—á–∏–Ω—É..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –±–æ—Ç–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ –∏–ª–∏ rate limiting
            bot_logs=$(pm2 logs northrepublic-bot --lines 10 2>/dev/null || echo "")
            if echo "$bot_logs" | grep -q "409.*Conflict\|terminated by other getUpdates request"; then
                echo "üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –±–æ—Ç–∞"
                echo "üìã Telegram API –∫–æ–Ω—Ñ–ª–∏–∫—Ç: –¥—Ä—É–≥–æ–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω"
                echo "‚è∞ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–¥–æ–∂–¥–∞—Ç—å 1-2 –º–∏–Ω—É—Ç—ã –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –¥–µ–ø–ª–æ–µ–º"
                echo "‚ö†Ô∏è Bot –Ω–µ –∑–∞–ø—É—â–µ–Ω, –Ω–æ –¥–µ–ø–ª–æ–π –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è"
            elif echo "$bot_logs" | grep -q "429.*Too Many Requests\|retry after"; then
                echo "üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –æ—à–∏–±–∫–∞ rate limiting - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –±–æ—Ç–∞"
                echo "üìã Telegram API —Ç—Ä–µ–±—É–µ—Ç –ø–∞—É–∑—É. –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∞–Ω–∞ –≤ –ª–æ–≥–∏"
                echo "‚è∞ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–¥–æ–∂–¥–∞—Ç—å 8-10 –º–∏–Ω—É—Ç –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º –¥–µ–ø–ª–æ–µ–º"
                echo "‚ö†Ô∏è Bot –Ω–µ –∑–∞–ø—É—â–µ–Ω, –Ω–æ –¥–µ–ø–ª–æ–π –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è"
            else
                echo "‚ùå Bot –Ω–µ –∑–∞–ø—É—â–µ–Ω –ø–æ –¥—Ä—É–≥–æ–π –ø—Ä–∏—á–∏–Ω–µ"
                pm2 list
                echo "üìã –õ–æ–≥–∏ bot:"
                pm2 logs northrepublic-bot --lines 5 || echo "‚ùå PM2 –ª–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
                exit 1
            fi
          fi
          
          echo "üéâ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
          
    - name: Notify success
      if: success()
      run: |
        echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üåê –°–∞–π—Ç: https://northrepublic.me"
        echo "üîß –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å: https://northrepublic.me/admin"
        echo "üì° Backend API: http://localhost:3002/api/health"
        
    - name: Notify failure
      if: failure()
      run: |
        echo "‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π!"
        echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
        echo "üîß –î–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏: ssh nr 'cd www/northrepublic.me && pm2 list && pm2 logs'"
