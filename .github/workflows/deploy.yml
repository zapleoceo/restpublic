name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Debug secrets
      run: |
        echo "Checking if secrets are available..."
        if [ -n "${{ secrets.PRODUCTION_HOST }}" ]; then
          echo "‚úÖ PRODUCTION_HOST is set"
        else
          echo "‚ùå PRODUCTION_HOST is missing"
          exit 1
        fi
        
        if [ -n "${{ secrets.PRODUCTION_USER }}" ]; then
          echo "‚úÖ PRODUCTION_USER is set"
        else
          echo "‚ùå PRODUCTION_USER is missing"
          exit 1
        fi
        
        if [ -n "${{ secrets.PRODUCTION_SSH_KEY }}" ]; then
          echo "‚úÖ PRODUCTION_SSH_KEY is set"
        else
          echo "‚ùå PRODUCTION_SSH_KEY is missing"
          exit 1
        fi
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 60m
        script: |
          cd /var/www/northrepubli_usr/data/www/northrepublic.me
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π Production..."
          echo "üìÖ –í—Ä–µ–º—è: $(date)"
          echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º Git —Å—Ç–∞—Ç—É—Å..."
          git status
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ —Å–∫—Ä–∏–ø—Ç
          chmod +x deploy.sh
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–ø–ª–æ–π —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          ./deploy.sh
          
          echo "‚úÖ –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π Production –∑–∞–≤–µ—Ä—à–µ–Ω!"
          
    - name: Health check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 10m
        script: |
          echo "üîç –í—ã–ø–æ–ª–Ω—è–µ–º health check..."
          sleep 15
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º backend
          echo "üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º backend API..."
          
          # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã..."
          pm2 list
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ backend
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 3002..."
          netstat -tlnp | grep :3002 || echo "‚ùå –ü–æ—Ä—Ç 3002 –Ω–µ –∑–∞–Ω—è—Ç"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º health endpoint
          curl -f http://localhost:3002/api/health || {
            echo "‚ùå Backend health check failed"
            echo "üìã –õ–æ–≥–∏ backend:"
            tail -n 20 /var/www/northrepubli_usr/data/www/northrepublic.me/logs/backend.log || echo "‚ùå –§–∞–π–ª –ª–æ–≥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            echo "üìã –õ–æ–≥–∏ PM2:"
            pm2 logs northrepublic-backend --lines 10 || echo "‚ùå PM2 –ª–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
            exit 1
          }
          

          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º frontend
          echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º frontend..."
          curl -f https://northrepublic.me/m > /dev/null || {
            echo "‚ùå Frontend check failed"
            exit 1
          }
          
          echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
