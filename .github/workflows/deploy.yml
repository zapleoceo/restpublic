name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Debug secrets
      run: |
        echo "Checking if secrets are available..."
        if [ -n "${{ secrets.PRODUCTION_HOST }}" ]; then
          echo "‚úÖ PRODUCTION_HOST is set"
        else
          echo "‚ùå PRODUCTION_HOST is missing"
          exit 1
        fi
        
        if [ -n "${{ secrets.PRODUCTION_USER }}" ]; then
          echo "‚úÖ PRODUCTION_USER is set"
        else
          echo "‚ùå PRODUCTION_USER is missing"
          exit 1
        fi
        
        if [ -n "${{ secrets.PRODUCTION_SSH_KEY }}" ]; then
          echo "‚úÖ PRODUCTION_SSH_KEY is set"
        else
          echo "‚ùå PRODUCTION_SSH_KEY is missing"
          exit 1
        fi
      
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 60m
        script: |
          cd /var/www/northrepubli_usr/data/www/northrepublic.me
          echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π Production..."
          echo "üìÖ –í—Ä–µ–º—è: $(date)"
          echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
          echo "üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º Git —Å—Ç–∞—Ç—É—Å..."
          git status
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
          echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã..."
          pm2 stop all || echo "PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
          pm2 delete all || echo "PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
          echo "üì• –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
          git pull origin main --allow-unrelated-histories --no-edit || {
            echo "‚ö†Ô∏è –û–±—ã—á–Ω—ã–π pull –Ω–µ —É–¥–∞–ª—Å—è, –≤—ã–ø–æ–ª–Ω—è–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π reset..."
            git fetch origin
            git reset --hard origin/main
          }
          
          # –°–æ–±–∏—Ä–∞–µ–º backend
          echo "üîß –°–æ–±–∏—Ä–∞–µ–º Backend..."
          cd backend
          npm install
          cd ..
          
          # –°–æ–±–∏—Ä–∞–µ–º frontend
          echo "üî® –°–æ–±–∏—Ä–∞–µ–º Frontend..."
          cd frontend
          npm install
          npm run build
          cp -r dist/* ../
          cd ..
          
          # –°–æ–±–∏—Ä–∞–µ–º bot
          echo "ü§ñ –°–æ–±–∏—Ä–∞–µ–º Telegram Bot..."
          cd bot
          npm install
          npm run build
          cd ..
          
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
          mkdir -p logs
          
          # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
          chmod +x bot/dist/bot.js
          chown -R northrepubli_usr:northrepubli_usr .
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã —á–µ—Ä–µ–∑ PM2
          echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã —á–µ—Ä–µ–∑ PM2..."
          pm2 start ecosystem.config.js --update-env
          
          echo "‚úÖ –ê–≤—Ç–æ–¥–µ–ø–ª–æ–π Production –∑–∞–≤–µ—Ä—à–µ–Ω!"
          
    - name: Health check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key: ${{ secrets.PRODUCTION_SSH_KEY }}
        port: 22
        timeout: 60s
        command_timeout: 10m
        script: |
          echo "üîç –í—ã–ø–æ–ª–Ω—è–µ–º health check..."
          sleep 20
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã..."
          pm2 list
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º backend
          echo "üì° –ü—Ä–æ–≤–µ—Ä—è–µ–º backend API..."
          for i in {1..5}; do
            echo "–ü–æ–ø—ã—Ç–∫–∞ $i –∏–∑ 5..."
            if curl -f http://localhost:3002/api/health; then
              echo "‚úÖ Backend —Ä–∞–±–æ—Ç–∞–µ—Ç!"
              break
            else
              echo "‚ùå –ü–æ–ø—ã—Ç–∫–∞ $i –Ω–µ —É–¥–∞–ª–∞—Å—å"
              if [ $i -eq 5 ]; then
                echo "‚ùå Backend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫"
                echo "üìã –õ–æ–≥–∏ PM2:"
                pm2 logs northrepublic-backend --lines 10 || echo "‚ùå PM2 –ª–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
                exit 1
              fi
              sleep 5
            fi
          done
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º frontend
          echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º frontend..."
          curl -f https://northrepublic.me > /dev/null || {
            echo "‚ùå Frontend check failed"
            exit 1
          }
          
          echo "‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!"
