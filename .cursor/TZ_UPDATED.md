# Техническое задание
## Проект: GoodZone - Развлекательный комплекс

Задача: реализовать полнофункциональный SPA-сайт и Telegram-бот с backend-сервером для развлекательного комплекса GoodZone, используя современные технологии и интеграцию с Poster POS API v3.

## Добавление функций в проект
Реализуйте ТОЛЬКО те функции, которые явно указаны в ТЗ. 
Если функция не описана в техническом задании - НЕ добавляйте её.
Реализуйте минимально необходимый функционал для выполнения ТЗ.
Не добавляйте "полезные" функции, если они не требуются.

### Источник данных

**Poster POS API v3:** https://dev.joinposter.com/docs/v3/web/index

Все названия категорий и товаров в Poster заполнены на английском (поле name_en).

**Poster Spot ID:** 1 (RestPublica)
- Заведение: RestPublica
- ID: 1
- Используется для создания заказов в Poster API

### Репозиторий и SSH

**Репозиторий:** https://github.com/zapleoceo/restpublic

**Подключение к серверу по SSH ключу:**
```bash
ssh goodzone
```

### Конфиденциальные данные

**Файл .env на сервере:**
```env
POSTER_API_TOKEN=your_poster_api_token_here
TELEGRAM_BOT_TOKEN=your_telegram_bot_token_here
SEPAY_API_TOKEN=your_sepay_api_token_here
NODE_ENV=production
PORT=3001
```

### Домен, развертывание и логи

**Сайт:** https://goodzone.zapleo.com (DNS и SSL настроены)

**Путь для файлов сайта:**
```
/var/www/goodzone_zap_usr/data/www/goodzone.zapleo.com
```

**Логи проекта:**
```
/var/www/goodzone_zap_usr/data/logs
```

### Backend-сервер (backend/)

**Технологии:** Node.js + Express.js + Axios + MySQL

**Структура:**
```
backend/
├── server.js
├── package.json
├── services/
│   └── configService.js
├── routes/
│   └── config.js
├── admin.js
├── sepay-monitor.js
├── sepay-service.js
└── ecosystem.config.js
```

**Функциональность:**
- Проксирование запросов к Poster API (`/api/poster/*`)
- Кэширование данных меню (5 минут)
- Кэширование данных популярности товаров (10 минут)
- Нормализация цен (деление на 100)
- Health check endpoint (`/api/health`)
- CORS настройки для безопасности
- Статическая раздача frontend файлов
- Логирование запросов и ошибок
- Обработка ошибок API
- **База данных**: MySQL для хранения конфигурации сайта
- **SePay мониторинг**: Автоматические уведомления о транзакциях

**API Endpoints:**
- `GET /api/health` - проверка состояния сервера
- `GET /api/menu` - кэшированные данные меню с нормализованными ценами
- `GET /api/products/popularity` - данные о популярности товаров за последние 3 дня
- `GET /api/poster/*` - прокси к Poster API
- `GET /api/config/site-config` - конфигурация сайта из БД
- `GET /api/config/site-sections` - секции сайта из БД
- `GET /api/config/translations/:language` - переводы из БД
- `GET /api/sepay/status` - статус SePay мониторинга
- `POST /api/sepay/reset` - сброс SePay мониторинга

### Веб-приложение (frontend/)

**Технологии:** React 18 + Vite + Tailwind CSS + i18next + Axios + Lucide React + FontAwesome

**Структура:**
```
frontend/
├── public/
│   ├── img/
│   │   └── logo.png
│   └── index.html
├── src/
│   ├── components/
│   │   ├── HomePage.jsx
│   │   ├── MenuPage.jsx
│   │   ├── FastAccessPage.jsx
│   │   ├── ContactSection.jsx
│   │   ├── HeroSection.jsx
│   │   ├── LanguageSwitcher.jsx
│   │   ├── LoadingSpinner.jsx
│   │   ├── SortSelector.jsx
│   │   └── ErrorBoundary.jsx
│   ├── hooks/
│   │   ├── useSiteConfig.js
│   │   └── useTranslations.js
│   ├── services/
│   │   └── menuService.js
│   ├── utils/
│   │   └── menuUtils.js
│   ├── App.jsx
│   ├── main.jsx
│   ├── i18n.js
│   └── index.css
├── package.json
├── vite.config.js
├── tailwind.config.js
└── postcss.config.js
```

**Функциональность:**
- SPA с React Router
- Трехъязычный интерфейс (RU, EN, VI) с глобальным переключением
- Переключатель языков без кодов стран (только EN, RU, VI)
- Адаптивный дизайн (mobile-first)
- **API-интеграция**: Хуки useSiteConfig и useTranslations для работы с API
- **Конфигурация**: Загружается из /api/config/site-config
- **Переводы**: Загружаются из /api/config/translations/:language
- **i18n**: Использует кастомный ApiBackend вместо статических файлов
- Главная страница с плитками разделов:
  - Меню (/m) - текущее меню с просмотром и сортировкой
  - Быстрый доступ (/fast) - быстрый доступ к основным функциям
  - Лазертаг (/lt)
  - Стрельба из лука (/bow)
  - Кинотеатр (/cinema)
  - Аренда беседки (/rent)
- Страница меню (/m) с отображением категорий и продуктов
- **Сортировка товаров**: по популярности (по умолчанию) и по алфавиту
- **Популярность товаров**: основана на количестве продаж за последние 3 дня
- **Будущая страница заказа (/menu)** - меню с заказом и регистрацией (в разработке)
- Контактная информация с картой и социальными сетями
- Отображение изображений товаров с fallback
- Форматирование цен (уже нормализованных backend'ом)
- Индикатор загрузки и обработка ошибок
- Анимации и hover-эффекты
- Скрытый div с версией приложения для отслеживания обновлений
- **Логотип**: logo.png (заменен с logo.svg)

**UI/UX:**
- Оранжево-красная цветовая схема
- Иконки Lucide React
- Градиенты и тени
- Плавные переходы
- Дизайн вдохновлен vn-gamezone.com

### Контактная информация

**Структура контактов:**
- **Верхний блок**: Телефон и локация в узких горизонтальных плитках
- **Нижний блок**: Социальные сети (Telegram, Instagram, TikTok, Facebook)
- **Карта**: Google Maps iframe внизу страницы

**Социальные сети:**
- Telegram: @goodzone_vn
- Instagram: @gamezone_vietnam
- TikTok: @gamezone_vietnam
- Facebook: gamezone.vietnam

**Контактные данные:**
- Телефон: +84 349 338 758
- Адрес: Trần Khát Chân, Đường Đệ, Nha Trang, Khánh Hòa, Vietnam

### Будущая функциональность заказа и регистрации (/menu)

Краткое резюме функциональности (полные требования см. раздел «Приложение: План разработки страницы /menu (архив)» ниже):
- Отдельная страница `/menu` для оформления заказов (в отличие от `/m`, где только просмотр меню)
- Корзина (добавление/удаление, количество, итог) в модальном окне
- Предложение регистрации с 20% скидкой на первый заказ; альтернатива — гостевой заказ
- Регистрация с полями (имя, фамилия, телефон, дата рождения, пол) и Telegram-верификацией (4-значный код)
- Авторизация по телефону, сессия через HttpOnly cookie; `client_id` хранится только на сервере
- Проверка «первого заказа» по транзакциям и/или группам клиента; применение скидки 20% при первом заказе
- Создание заказа в Poster Incoming Orders, комментарии, скидки; генерация QR через SePay
- Все детальные сценарии, поля, эндпойнты и алгоритмы — в Приложении

### Telegram-бот (bot/)

**Технологии:** Node.js + TypeScript + Telegraf + Axios

**Структура:**
```
bot/
├── src/
│   ├── bot.ts
│   ├── handlers/
│   │   └── menuHandler.ts
│   ├── services/
│   │   └── posterService.ts
│   └── utils/
│       └── priceUtils.ts
├── package.json
├── tsconfig.json
└── .gitignore
```

**Функциональность:**
- Команды: `/start`, `/help`
- Встроенные кнопки: "🍽️ Меню", "📞 Контакты"
- Показ всех продуктов с группировкой по категориям
- Показ контактов ресторана
- Использование backend API для получения нормализованных цен
- Форматирование цен в донгах
- Обработка всех текстовых сообщений

### Обработка данных

**Фильтрация:**
- Исключение скрытых товаров (`hidden !== "1"`)
- Группировка продуктов по категориям

**Форматирование:**
- Цены: нормализация в backend (деление на 100)
- Изображения: обработка отсутствующих фото
- Названия: многоязычная поддержка

**Сортировка товаров:**
- **По популярности**: основана на количестве продаж за последние 3 дня (API: `dash.getProductsSales`)
- **По алфавиту**: сортировка по названию товара
- **По умолчанию**: сортировка по популярности

### Автоматизация деплоя

**Скрипты:**
- `deploy.sh` - основной скрипт автоматического деплоя v2.1
- `deploy_backup.sh` - резервный скрипт
- `DEPLOY.md` - документация по деплою

**Процесс деплоя:**
1. Обновление кода из Git
2. Остановка и удаление старых PM2 процессов
3. Сборка backend
4. Сборка frontend
5. Сборка бота
6. Запуск всех сервисов через PM2
7. Проверка статуса всех сервисов
8. Логирование результатов

**PM2 конфигурация:**
- Backend процесс: restpublic-backend
- Bot процесс: restpublic-bot
- Автоматический перезапуск при сбоях
- Логирование в отдельные файлы

**GitHub Actions:**
- Автодеплой при push в main ветку
- Подробное логирование процесса деплоя
- Health check после деплоя
- Проверка frontend и backend

### Система логирования

**Логи:**
- Backend: `logs/backend.log`
- Bot: `logs/bot.log`
- Ошибки: `logs/backend-error.log`, `logs/bot-error.log`

**Мониторинг:**
- Проверка процессов: `pm2 list`
- Просмотр логов: `pm2 logs restpublic-backend`

### Обработка ошибок

**Frontend:**
- ErrorBoundary для React компонентов
- Try-catch для API запросов
- Fallback UI для ошибок

**Backend:**
- Обработка ошибок API
- Graceful degradation
- Логирование ошибок

**Bot:**
- Try-catch в обработчиках
- Обработка ошибок API
- Fallback для недоступности backend

### Безопасность

**Секреты:**
- Все секреты хранятся в .env файле на сервере
- Git история очищена от секретов
- ecosystem.config.js использует env_file
- Права доступа к .env: 600 (только владелец)

**Переменные окружения:**
- POSTER_API_TOKEN
- TELEGRAM_BOT_TOKEN
- SEPAY_API_TOKEN
- NODE_ENV=production
- PORT=3001

### Конфигурация сборки

**Frontend (Vite):**
- Code splitting
- Оптимизация изображений
- Отключение source maps для production

**Bot (TypeScript):**
- Компиляция в ES2020
- Source maps для разработки

### Документация

**Файлы:**
- `README.md` - основная документация проекта
- `DEPLOY.md` - инструкции по деплою
- `.cursor/rules.md` - правила разработки

### Git и CI

**Ветки:** main (продакшен)

**Файл .gitignore:**
- node_modules
- .env
- сборки (dist, build)
- логи
- IDE файлы

**Правила коммитов:**
- Всегда на русском языке
- Перед push повышать версии в package.json
- Перед push повышать APP_VERSION в ecosystem.config.js

### База данных и конфигурация

**База данных:**
- **Технология**: MySQL для хранения конфигурации сайта
- **Таблицы**: site_config, site_sections, site_translations
- **Миграция**: Данные перенесены из статических файлов в БД
- **Кэширование**: Backend кэширует данные из БД для производительности

**API Endpoints для конфигурации:**
- `GET /api/config/site-config` - основная конфигурация сайта
- `GET /api/config/site-sections` - секции и страницы сайта
- `GET /api/config/translations/:language` - переводы для указанного языка

### Мониторинг транзакций SePay

**Интеграция с SePay API:**
- API Endpoint: `https://my.sepay.vn/userapi/transactions/list`
- Авторизация: Bearer Token
- API Token: хранится в переменной окружения `SEPAY_API_TOKEN`
- Лимит запросов: 2 запроса в секунду

**Функциональность мониторинга:**
- Периодический опрос API каждые 2 секунды
- Отслеживание новых входящих транзакций
- Автоматическая отправка уведомлений в Telegram
- Целевые чаты: `Rest_publica_bar`, `zapleosoft`
- **API endpoints**: /api/sepay/* для управления мониторингом
- **Сброс мониторинга**: /api/sepay/reset для переинициализации
- **Переинициализация**: Автоматическое обновление при обнаружении новых транзакций

**Структура уведомления:**
```
💵 **Новый платеж: {amount} VND**

📅 Время: {date}
📝 Описание: {transaction_content}
🏦 Банк: {bank_brand_name}
📊 Счет: {account_number}
```

**Backend компоненты:**
- `sepay-monitor.js` - основной скрипт мониторинга
- `sepay-service.js` - сервис для работы с SePay API
- Интеграция с существующим Telegram ботом
- Логирование всех транзакций

**Безопасность:**
- Проверка подписи webhook (если используется)
- Валидация данных транзакций
- Rate limiting для API запросов
- Логирование ошибок и подозрительных транзакций
- Автоматическая остановка при критических ошибках

### Известные проблемы и решения

**Автодеплой GitHub Actions:**
- Проблема: Не срабатывает автоматически
- Решение: Использовать ручной деплой через SSH
- Статус: Требует диагностики

**Line Endings в deploy.sh:**
- Проблема: CRLF в Unix окружении
- Решение: `sed -i 's/\r$//' deploy.sh`
- Статус: Решено

**Цены в Telegram боте:**
- Проблема: Бот получал необработанные цены от Poster API
- Решение: Бот теперь использует backend с нормализованными ценами
- Статус: Решено

**Сортировка по популярности:**
- Проблема: Неправильный API метод для получения данных о продажах
- Решение: Использование `dash.getProductsSales` вместо `dash.getTransactions`
- Статус: Решено

### Проверка работы

- Веб-сайт: https://northrepublic.me
- Backend API: https://northrepublic.me/api/health
- Конфигурация: https://northrepublic.me/api/config/site-config
- Переводы: https://northrepublic.me/api/config/translations/ru
- SePay статус: https://northrepublic.me/api/sepay/status
- Логи: `pm2 logs northrepublic-backend`
- Процессы: `pm2 list`

## 4. Telegram авторизация

### 4.1 Общий алгоритм авторизации
1. **Инициация авторизации**: Пользователь нажимает кнопку "Войти через Telegram" на сайте
2. **Переход в бот**: Открывается Telegram бот @RestPublic_bot с кнопкой "📱 Авторизоваться"
3. **Передача контакта**: Пользователь нажимает кнопку и делится своим контактом
4. **Обработка на backend**: Backend получает данные, создает/находит клиента в Poster API
5. **Создание сессии**: Формируется сессия с данными пользователя и временем истечения
6. **Возврат на сайт**: Пользователь получает ссылку для возврата на исходную страницу сайта
7. **Сохранение сессии**: Сессия сохраняется в localStorage браузера

### 4.2 API endpoints для авторизации
- `POST /api/auth/telegram-callback` - обработка данных авторизации от Telegram бота
- `GET /api/auth/session/:token` - получение данных сессии по токену (если используется)

### 4.3 Структура сессии
```json
{
  "userId": "123",           // ID клиента в Poster API
  "userData": {
    "name": "Иван",          // Имя пользователя
    "lastName": "Иванов",    // Фамилия пользователя  
    "phone": "+1234567890",  // Номер телефона
    "birthday": "",          // День рождения (опционально)
    "gender": ""             // Пол (опционально)
  },
  "expiresAt": "2025-01-01T00:00:00.000Z"  // Время истечения сессии
}
```

### 4.4 Telegram бот конфигурация
- **Основной бот**: @RestPublic_bot
- **Команды**: Минимальный набор (только /start для авторизации)
- **Встроенное меню**: Отключено для упрощения интерфейса
- **Кнопки**: Только "📱 Авторизоваться" (с запросом контакта)

### 4.5 Особенности реализации
- **Возврат на исходную страницу**: Бот запоминает URL страницы, с которой пришел пользователь
- **Упрощенная модалка**: Модальное окно авторизации содержит только кнопки внешних сервисов
- **Локальное хранение**: Сессия сохраняется в localStorage с ключом `user_session`
- **Автоматическое обновление**: После получения сессии страница перезагружается для применения авторизации

## 5. Система быстрого доступа

### 5.1 Маршруты быстрого доступа
- `/fast/:tableId/menu` - прямой доступ к меню для конкретного стола
- Автоматическое определение номера стола из URL
- Сохранение номера стола в контексте для использования в заказах

### 5.2 Логика работы
1. Пользователь переходит по ссылке с номером стола
2. Номер стола автоматически сохраняется в контексте приложения
3. При оформлении заказа номер стола подставляется автоматически
4. Не требуется дополнительный ввод номера стола пользователем

## 6. Система заказов с клиентами

### 6.1 Работа с клиентами Poster API
- **Автоматическое создание**: Клиенты создаются автоматически при первом заказе. Перед созданием обязательно проверить наличие уже существующего пользователя, если существует, то не создавтаь дубль. Ключевое поле поиска - номер телефона.
- **Поиск по телефону**: Существующие клиенты находятся по номеру телефона
- **Данные клиента**: Имя, фамилия, телефон передаются в Poster API

### 6.2 Логика активных заказов
- **Поиск активных заказов**: Система ищет незавершенные заказы клиента за последние 6 часов (статусы актиынх заказов = 0,1,2,3)
- **Статусы заказов**: Статус 0 (новый), 1 (в процессе) 2 — READY (Готов) 3 — SERVED (Подан) 4 — CLOSED/PAID (Закрыт/Оплачен) 5 — CANCELLED (Отменен) 6 — ON_HOLD (Приостановлен) 7 — PARTIALLY_SERVED (Частично подан)
- **Объединение заказов**: Новые товары добавляются к существующему активному заказу
- **Создание нового заказа**: Если активных заказов нет, создается новый

### 6.3 API endpoints заказов
- `POST /api/orders/create` - создание нового заказа или добавление к существующему
- Автоматическое определение необходимости создания нового заказа или добавления к существующему

Это ТЗ отражает актуальное состояние проекта GoodZone с учетом всех реализованных функций: backend-сервера, мультиязычного frontend с сортировкой, Telegram-бота, системы авторизации, быстрого доступа и автоматизации деплоя.



## Приложение: План разработки страницы /menu (архив)

# План разработки страницы /menu

## Обзор
Создание новой страницы `/menu` для заказов с системой регистрации/авторизации пользователей через номер телефона.

## 1. Backend API Endpoints

### 1.1 Проверка существующего пользователя
```
POST /api/auth/check-phone
Body: { "phone": "+84XXXXXXXXX" }
Response: { "exists": true/false, "user": {...} }
```
- Использовать Poster API `clients.getClientsList` с фильтром по номеру
- Возвращать данные пользователя если найден

### 1.2 Регистрация нового пользователя
```
POST /api/auth/register
Body: { "phone": "...", "first_name": "...", "last_name": "...", "birth_date": "...", "gender": "..." }
Response: { "success": true, "user_id": "..." }
```
- Использовать Poster API `clients.createClient`
- Создавать клиента в Poster в группе ID 4

### 1.3 Telegram верификация
```
POST /api/auth/send-code
Body: { "phone": "+84XXXXXXXXX" }
Response: { "success": true, "code_sent": true }

POST /api/auth/verify-code
Body: { "phone": "+84XXXXXXXXX", "code": "1234" }
Response: { "success": true, "verified": true }
```
- Генерировать 4-значный код
- Отправлять через Telegram бот
- Проверять код

### 1.4 Авторизация пользователя
```
POST /api/auth/login
Body: { "phone": "+84XXXXXXXXX" }
Response: { "success": true, "token": "...", "user": {...} }
```
- Создавать JWT токен
- Устанавливать HttpOnly Secure Cookie
- Возвращать данные пользователя

### 1.5 Проверка первого заказа. Признаком отсутствия заказов с регистрацией является или отсутствие клиента или его приутствие в группе id 1. При первом заказе со скидеой в 20$ пользотвателя надо переместить из группы 1 в группу 4. Если пользователь уже в группе 4, то скидка ему уже не применяется. Текст сообщения "Вы уже использовали свою скидку на первый заказ"
```
POST /api/orders/check-first
Body: { "client_id": "..." }
Response: { "is_first": true/false }
```
- Использовать Poster API `dash.getTransactions`
- Проверять наличие заказов у клиента

### 1.6 Создание заказа
```
POST /api/orders/create
Body: { "products": [...], "client_id": "...", "comment": "..." }
Response: { "success": true, "order_id": "...", "qr_code": "..." }
```
- Использовать Poster API `incomingOrders.createIncomingOrder`
- Применять скидку 20% для первого заказа
- Генерировать QR код для оплаты через SePay
- Добавлять номер заказа в комментарий QR кода

### 1.7 Генерация QR кода для оплаты
```
POST /api/payment/generate-qr
Body: { "amount": 500000, "order_id": "12345", "comment": "Заказ #12345" }
Response: { "success": true, "qr_url": "...", "transaction_id": "..." }
```
- Генерация QR кода через SePay API
- Использование BIDV банковских данных
- Добавление номера заказа в комментарий для отслеживания
- Отправка QR кода в Telegram как изображение

### 1.8 Получение QR кода заказа
```
GET /api/orders/{order_id}/qr
Response: { "success": true, "qr_url": "...", "amount": 500000, "order_id": "12345" }
```
- Получение QR кода для существующего заказа
- Автоматический расчет суммы заказа
- Генерация комментария с номером заказа

## 2. Frontend компоненты

### 2.1 MenuPage.jsx (новая страница)
- Отдельная от существующей MenuPage для просмотра
- Автоматическая проверка номера телефона из URL
- Система авторизации/регистрации
- Корзина товаров
- Форма заказа

### 2.2 AuthContext.jsx
- React Context для управления авторизацией
- Хранение данных пользователя
- Методы авторизации/регистрации
- Проверка токена

### 2.3 RegistrationForm.jsx
- Форма регистрации с валидацией
- Поля: имя, фамилия, телефон, дата рождения, пол
- Маски для полей
- Проверка существующего номера

### 2.4 LoginForm.jsx
- Форма авторизации по номеру телефона
- Telegram верификация
- Ввод кода подтверждения

### 2.5 Cart.jsx
- Корзина товаров
- Добавление/удаление позиций
- Изменение количества
- Расчет итоговой суммы
- Применение скидки

### 2.6 OrderForm.jsx
- Форма оформления заказа
- Поля: комментарий, способ оплаты
- Подтверждение заказа
- Предложение регистрации
- Отображение QR кода для оплаты

### 2.7 QRCodeDisplay.jsx
- Компонент отображения QR кода
- Скачивание QR кода
- Копирование ссылки на оплату
- Инструкции по оплате
- Отслеживание статуса оплаты

## 3. Интеграция с Telegram ботом

### 3.1 Обновление кнопки "МЕНЮ"
- Изменить обработчик кнопки
- Генерировать ссылку: `/menu?phone=+84XXXXXXXXX`
- Получать номер телефона из Telegram (если доступно)

### 3.2 Telegram верификация
- Отправка кода через бот
- Обработка ответов пользователя
- Валидация кода

### 3.3 Отправка QR кодов в Telegram
- Автоматическая отправка QR кода при создании заказа
- Отправка QR как изображение с подписью
- Уведомления о статусе оплаты
- Связывание QR кода с номером заказа

## 4. Система безопасности

### 4.1 JWT токены
- Создание токенов при авторизации
- Хранение в HttpOnly Secure Cookie
- Валидация токенов
- Автоматическое обновление

### 4.2 Валидация данных
- Проверка номера телефона
- Валидация форм
- Защита от XSS/CSRF
- Rate limiting для API

## 5. База данных и кэширование

### 5.1 Кэширование пользователей
- Кэш данных пользователей (5 минут)
- Кэш результатов проверки номера (1 минута)
- Инвалидация кэша при изменениях

### 5.2 Кэширование QR кодов
- Кэш сгенерированных QR кодов (30 минут)
- Кэш URL QR кодов для повторного использования
- Инвалидация при изменении суммы заказа

### 5.3 Логирование
- Логи авторизаций
- Логи заказов
- Логи генерации QR кодов
- Логи оплат и уведомлений
- Аналитика

## 6. UI/UX дизайн

### 6.1 Адаптивный дизайн
- Mobile-first подход
- Поддержка всех устройств
- Оптимизация для мобильных

### 6.2 Анимации и переходы
- Плавные переходы между состояниями
- Индикаторы загрузки
- Анимации корзины
- Hover эффекты

### 6.3 QR код дизайн
- Стилизованное отображение QR кода
- Анимация генерации QR
- Кнопки скачивания и копирования
- Инструкции по оплате
- Статус оплаты с индикаторами

### 6.4 Цветовая схема
- Соответствие дизайну GoodZone
- Оранжево-красная палитра
- Контрастность для доступности

## 7. Многоязычность

### 7.1 Переводы
- Добавить переводы для новых компонентов
- Поддержка RU/EN/VI
- Динамическое переключение

### 7.2 Локализация
- Форматы дат
- Форматы телефонов
- Валюты

### 7.3 Переводы для QR оплаты
- Инструкции по оплате
- Сообщения о статусе
- Тексты уведомлений
- Описания ошибок

## 8. Тестирование

### 8.1 Unit тесты
- Тестирование API endpoints
- Тестирование компонентов
- Тестирование утилит
- Тестирование генерации QR кодов

### 8.2 Integration тесты
- Тестирование авторизации
- Тестирование заказов
- Тестирование интеграции с Poster
- Тестирование SePay QR API

### 8.3 E2E тесты
- Полный flow регистрации
- Полный flow заказа
- Полный flow оплаты через QR
- Тестирование на разных устройствах

## 9. Деплой и мониторинг

### 9.1 Обновление версий
- Backend: 1.0.25+
- Frontend: 2.2.21+
- APP_VERSION: 2.3.22+

### 9.2 Мониторинг
- Health checks для новых endpoints
- Мониторинг ошибок
- Метрики производительности
- Мониторинг QR генерации
- Отслеживание успешных оплат

## 10. Документация

### 10.1 API документация
- Описание всех endpoints
- Примеры запросов/ответов
- Коды ошибок
- Документация QR API

### 10.2 Пользовательская документация
- Инструкции по использованию
- FAQ
- Troubleshooting
- Инструкции по оплате через QR

### 10.3 Техническая документация
- Алгоритм генерации QR кодов
- Интеграция с SePay API
- Отслеживание транзакций
- Обработка уведомлений

## Приоритеты разработки

### Высокий приоритет (1-я неделя)
1. Backend API для проверки пользователя
2. Базовая страница /menu
3. AuthContext
4. Обновление Telegram бота
5. Генерация QR кодов для оплаты

### Средний приоритет (2-я неделя)
1. Формы регистрации/авторизации
2. Telegram верификация
3. Корзина товаров
4. Система безопасности
5. Интеграция QR оплаты с заказами

### Низкий приоритет (3-я неделя)
1. Дополнительные UI улучшения
2. Расширенная аналитика
3. Оптимизация производительности
4. Дополнительные тесты
5. Расширенные функции QR оплаты

## Технические требования

### Backend
- Node.js + Express
- JWT для токенов
- Axios для Poster API
- Валидация данных
- Логирование
- QR код генерация

### Frontend
- React 18 + Hooks
- React Router
- Context API
- Tailwind CSS
- i18next
- QR код отображение

### Интеграции
- Poster POS API v3
- Telegram Bot API
- SePay QR API
- Cookie management
- Local storage

## Риски и митигация

### Риски
1. Сложность интеграции с Poster API
2. Проблемы с Telegram верификацией
3. Проблемы с безопасностью
4. Производительность при большом количестве пользователей
5. Проблемы с генерацией QR кодов
6. Отслеживание оплат через комментарии

### Митигация
1. Тщательное тестирование API
2. Fallback механизмы
3. Многоуровневая безопасность
4. Кэширование и оптимизация
5. Резервные методы генерации QR
6. Уникальные идентификаторы транзакций

## 11. QR код система оплаты

### 11.1 Алгоритм генерации QR кодов
```javascript
// Основная функция генерации QR
function generateQRCode(amount, orderId, comment) {
    const bidvAccount = process.env.BIDV_ACCOUNT_NUMBER;
    const bankCode = 'BIDV';
    const fullComment = `${comment} #${orderId}`;
    const encodedComment = encodeURIComponent(fullComment);
    
    return `https://qr.sepay.vn/img?acc=${bidvAccount}&bank=${bankCode}&amount=${amount}&des=${encodedComment}&template=compact`;
}
```

### 11.2 Структура QR кода
- **acc**: Номер счета BIDV
- **bank**: Код банка (BIDV)
- **amount**: Сумма в VND
- **des**: Комментарий с номером заказа
- **template**: Шаблон отображения (compact)

### 11.3 Отслеживание транзакций
- Номер заказа добавляется в комментарий QR кода
- При поступлении платежа извлекается номер заказа
- Автоматическое связывание оплаты с заказом
- Уведомления о статусе оплаты

### 11.4 Telegram интеграция
- Отправка QR кода как изображение
- Подпись с информацией о заказе
- Уведомления о поступлении средств
- Статус оплаты в реальном времени

### 11.5 Кэширование QR кодов
- Кэш URL QR кодов (30 минут)
- Избежание повторной генерации
- Инвалидация при изменении суммы
- Оптимизация производительности