# Миграция структуры событий

## Обзор изменений

Структура данных событий в MongoDB была обновлена для соответствия техническому заданию виджета событий с поддержкой многоязычности.

## Новая структура данных

### До миграции:
```json
{
  "_id": "ObjectId",
  "title": "string",
  "date": "YYYY-MM-DD",
  "time": "HH:MM",
  "conditions": "string",
  "description_link": "string",
  "image": "GridFS file_id",
  "comment": "string",
  "is_active": boolean,
  "created_at": "UTCDateTime",
  "updated_at": "UTCDateTime"
}
```

### После миграции:
```json
{
  "_id": "ObjectId",
  "title_ru": "string",
  "title_en": "string",
  "title_vi": "string",
  "description_ru": "string",
  "description_en": "string",
  "description_vi": "string",
  "conditions_ru": "string",
  "conditions_en": "string",
  "conditions_vi": "string",
  "date": "YYYY-MM-DD",
  "time": "HH:MM",
  "image": "GridFS file_id",
  "link": "string",
  "category": "string",
  "is_active": boolean,
  "created_at": "UTCDateTime"
}
```

## Изменения в коде

### 1. API (admin/events/api.php)
- Обновлена валидация полей: `title_ru`, `conditions_ru` вместо `title`, `conditions`
- Добавлена поддержка полей переводов для всех языков
- Обновлена структура данных при создании и обновлении событий
- Добавлено поле `category` с значением по умолчанию `general`

### 2. Админка (admin/events/index.php)
- Обновлена модалка с полями для переводов на 3 языка
- В таблице отображаются только русские версии полей
- Добавлена кнопка "КОПИРОВАТЬ" для каждого события
- Обновлена валидация формы для новых полей
- Добавлено поле выбора категории события

### 3. EventsService (classes/EventsService.php)
- Обновлена логика получения локализованных полей
- Поддержка fallback на русский язык для пустых переводов

## Функции

### Кнопка "КОПИРОВАТЬ"
- Открывает модалку создания нового события
- Заполняет все поля данными копируемого события
- Позволяет изменить дату и создать новое событие

### Многоязычность
- Поддержка русского (RU), английского (EN) и вьетнамского (VI) языков
- Автоматический fallback на русский язык если перевод не заполнен
- Отдельные поля для названий, описаний и условий участия

### Категории событий
- general - Общее
- entertainment - Развлечения  
- food - Еда и напитки
- music - Музыка
- sports - Спорт
- cultural - Культурные мероприятия

## Миграция данных

Для обновления существующих событий запустите скрипт миграции:

```bash
php migrate_events_structure.php
```

Скрипт:
- Копирует `title` → `title_ru/en/vi`
- Копирует `conditions` → `conditions_ru/en/vi`
- Переименовывает `description_link` → `link`
- Добавляет пустые поля `description_ru/en/vi`
- Устанавливает `category: 'general'` для всех событий

## Совместимость

Код поддерживает обратную совместимость:
- Если новые поля отсутствуют, используются старые поля
- Fallback логика обеспечивает корректное отображение данных
- API автоматически заполняет пустые переводы русскими значениями

## Тестирование

После миграции проверьте:
1. Отображение событий в админке
2. Создание новых событий с переводами
3. Копирование событий
4. Редактирование существующих событий
5. Работу публичного API для виджета
