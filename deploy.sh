#!/bin/bash

# North Republic Deployment Script v5.2
# ะญัะพั ัะบัะธะฟั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะพะฑะฝะพะฒะปัะตั ะบะพะด, ัะพะฑะธัะฐะตั ะฟัะธะปะพะถะตะฝะธั ะธ ะฟะตัะตะทะฐะฟััะบะฐะตั ัะตัะฒะธัั
set -e  # ะััะฐะฝะพะฒะธัั ะฒัะฟะพะปะฝะตะฝะธะต ะฟัะธ ะพัะธะฑะบะต

# ะคัะฝะบัะธั ะดะปั ะปะพะณะธัะพะฒะฐะฝะธั ั ะฒัะตะผะตะฝะฝัะผะธ ะผะตัะบะฐะผะธ
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# ะคัะฝะบัะธั ะดะปั ะฒัะฟะพะปะฝะตะฝะธั ะบะพะผะฐะฝะดั ั ะฟะพะดัะพะฑะฝัะผ ะปะพะณะธัะพะฒะฐะฝะธะตะผ
run_command() {
    local description="$1"
    local command="$2"
    
    log "๐ ะะะงะะะะะ: $description"
    log "๐ ะะพะผะฐะฝะดะฐ: $command"
    log "โฐ ะัะตะผั ะฝะฐัะฐะปะฐ: $(date)"
    
    # ะัะฟะพะปะฝัะตะผ ะบะพะผะฐะฝะดั ะธ ัะพััะฐะฝัะตะผ exit code
    if eval "$command"; then
        log "โ ะฃะกะะะจะะ: $description"
        log "โฐ ะัะตะผั ะทะฐะฒะตััะตะฝะธั: $(date)"
    else
        local exit_code=$?
        log "โ ะะจะะะะ: $description (exit code: $exit_code)"
        log "โฐ ะัะตะผั ะพัะธะฑะบะธ: $(date)"
        return $exit_code
    fi
}

# ะคัะฝะบัะธั ะดะปั ะฟัะพะฒะตัะบะธ ะฟัะพัะตััะฐ
check_process() {
    local process_name="$1"
    log "๐ ะัะพะฒะตััะตะผ ะฟัะพัะตัั: $process_name"
    if pgrep -f "$process_name" > /dev/null; then
        log "โ ะัะพัะตัั $process_name ะทะฐะฟััะตะฝ"
        pgrep -f "$process_name" | xargs ps -p
    else
        log "โ ะัะพัะตัั $process_name ะฝะต ะฝะฐะนะดะตะฝ"
    fi
}

log "๐ ========================================="
log "๐ ะะะงะะะะะ ะะะะะะ North Republic v5.2"
log "๐ ========================================="
log "๐ ะัะตะผั ะฝะฐัะฐะปะฐ: $(date)"
log "๐ป ะกะธััะตะผะฐ: $(uname -a)"
log "๐พ ะะฐะผััั: $(free -h | grep Mem | awk '{print $2}')"
log "๐ฝ ะะธัะบ: $(df -h . | tail -1 | awk '{print $4}') ัะฒะพะฑะพะดะฝะพ"

# ะะตัะตัะพะดะธะผ ะฒ ัะฐะฑะพััั ะดะธัะตะบัะพัะธั
run_command "ะะตัะตัะพะด ะฒ ัะฐะฑะพััั ะดะธัะตะบัะพัะธั" "cd /var/www/northrepubli_usr/data/www/northrepublic.me"
log "๐ ะะฐะฑะพัะฐั ะดะธัะตะบัะพัะธั: $(pwd)"
log "๐ ะะฐะทะผะตั ะดะธัะตะบัะพัะธะธ: $(du -sh . | cut -f1)"

# ะะฐัััะพะนะบะธ Git
run_command "ะะฐัััะพะนะบะฐ Git" "git config --local core.editor /bin/true && git config --local merge.tool /bin/true"
export GIT_EDITOR=/bin/true
export EDITOR=/bin/true

# ะัะพะฒะตััะตะผ Git ััะฐััั
run_command "ะัะพะฒะตัะบะฐ Git ััะฐัััะฐ" "git status --porcelain"
log "๐ ะะพัะปะตะดะฝะธะต ะบะพะผะผะธัั:"
git log --oneline -3 || log "โ๏ธ ะะต ัะดะฐะปะพัั ะฟะพะปััะธัั ะธััะพัะธั ะบะพะผะผะธัะพะฒ"

# ะะฑะฝะพะฒะปัะตะผ ะบะพะด
run_command "ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ ะธะท ัะตะฟะพะทะธัะพัะธั" "git pull origin main --allow-unrelated-histories --no-edit"

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ PM2 ะฟัะพัะตััั
log "๐ ========================================="
log "๐ ะะกะขะะะะะะ PM2 ะะะะฆะะกะกะะ"
log "๐ ========================================="

run_command "ะััะฐะฝะพะฒะบะฐ ะฒัะตั PM2 ะฟัะพัะตััะพะฒ" "pm2 stop all"
run_command "ะฃะดะฐะปะตะฝะธะต ะฒัะตั PM2 ะฟัะพัะตััะพะฒ" "pm2 delete all"

log "๐ ะกัะฐััั PM2 ะฟะพัะปะต ะพััะฐะฝะพะฒะบะธ:"
pm2 list

# ะกะฑะพัะบะฐ Backend
log "๐ง ========================================="
log "๐ง ะกะะะะะ BACKEND"
log "๐ง ========================================="

run_command "ะะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั backend" "cd backend"
log "๐ ะะธัะตะบัะพัะธั backend: $(pwd)"

run_command "ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน backend" "npm install"
log "๐ฆ ะะฐะฒะธัะธะผะพััะธ backend ัััะฐะฝะพะฒะปะตะฝั"

run_command "ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ logs" "mkdir -p ../logs"
log "๐ ะะธัะตะบัะพัะธั logs ัะพะทะดะฐะฝะฐ"

# MongoDB ะผะธะณัะฐัะธั
log "๐ ========================================="
log "๐ MONGODB ะะะะะะฆะะฏ"
log "๐ ========================================="

log "๐ ะัะพะฒะตััะตะผ ะดะพัััะฟะฝะพััั MongoDB..."
if ! timeout 10 bash -c 'until nc -z 127.0.0.1 27017; do sleep 1; done'; then
    log "โ MongoDB ะฝะตะดะพัััะฟะฝะฐ ะฝะฐ ะฟะพััั 27017"
    exit 1
fi
log "โ MongoDB ะดะพัััะฟะฝะฐ ะฝะฐ ะฟะพััั 27017"

log "๐ ะะฐะฟััะบะฐะตะผ ะผะธะณัะฐัะธั MongoDB..."
run_command "MongoDB ะผะธะณัะฐัะธั" "node scripts/migrate-to-mongodb.js"
log "โ ะะธะณัะฐัะธั MongoDB ะทะฐะฒะตััะตะฝะฐ"

run_command "ะะพะทะฒัะฐั ะฒ ะบะพัะฝะตะฒัั ะดะธัะตะบัะพัะธั" "cd .."
log "๐ ะะตัะฝัะปะธัั ะฒ: $(pwd)"

# ะกะฑะพัะบะฐ Frontend
log "๐จ ========================================="
log "๐จ ะกะะะะะ FRONTEND"
log "๐จ ========================================="

run_command "ะะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั frontend" "cd frontend"
log "๐ ะะธัะตะบัะพัะธั frontend: $(pwd)"
log "๐ ะะฐะทะผะตั node_modules: $(du -sh node_modules 2>/dev/null || echo 'ะฝะต ัััะตััะฒัะตั')"

run_command "ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน frontend" "npm install"
log "๐ฆ ะะฐะฒะธัะธะผะพััะธ frontend ัััะฐะฝะพะฒะปะตะฝั"

log "๐๏ธ ะะฐะฟััะบะฐะตะผ ัะฑะพัะบั frontend..."
run_command "ะกะฑะพัะบะฐ frontend" "npm run build"
log "โ ะกะฑะพัะบะฐ frontend ะทะฐะฒะตััะตะฝะฐ"

log "๐ ะะพะฟะธััะตะผ ัะพะฑัะฐะฝะฝัะต ัะฐะนะปั..."
run_command "ะะพะฟะธัะพะฒะฐะฝะธะต ัะฐะนะปะพะฒ frontend" "cp -r dist/* ../"
log "โ ะคะฐะนะปั frontend ัะบะพะฟะธัะพะฒะฐะฝั"

run_command "ะะพะทะฒัะฐั ะฒ ะบะพัะฝะตะฒัั ะดะธัะตะบัะพัะธั" "cd .."
log "๐ ะะตัะฝัะปะธัั ะฒ: $(pwd)"

# ะกะฑะพัะบะฐ Bot
log "๐ค ========================================="
log "๐ค ะกะะะะะ TELEGRAM BOT"
log "๐ค ========================================="

run_command "ะะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั bot" "cd bot"
log "๐ ะะธัะตะบัะพัะธั bot: $(pwd)"

run_command "ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน bot" "npm install"
log "๐ฆ ะะฐะฒะธัะธะผะพััะธ bot ัััะฐะฝะพะฒะปะตะฝั"

run_command "ะกะฑะพัะบะฐ bot" "npm run build"
log "โ ะกะฑะพัะบะฐ bot ะทะฐะฒะตััะตะฝะฐ"

run_command "ะะพะทะฒัะฐั ะฒ ะบะพัะฝะตะฒัั ะดะธัะตะบัะพัะธั" "cd .."
log "๐ ะะตัะฝัะปะธัั ะฒ: $(pwd)"

# ะะฐัััะพะนะบะฐ ะฟัะฐะฒ ะดะพัััะฟะฐ
log "๐ ========================================="
log "๐ ะะะกะขะะะะะ ะะะะ ะะะกะขะฃะะ"
log "๐ ========================================="

run_command "ะฃััะฐะฝะพะฒะบะฐ ะฟัะฐะฒ ะฝะฐ bot.js" "chmod +x bot/dist/bot.js"
run_command "ะะทะผะตะฝะตะฝะธะต ะฒะปะฐะดะตะปััะฐ ัะฐะนะปะพะฒ" "chown -R northrepubli_usr:northrepubli_usr ."
log "โ ะัะฐะฒะฐ ะดะพัััะฟะฐ ะฝะฐัััะพะตะฝั"

# ะะฐะฟััะบ PM2 ะฟัะพัะตััะพะฒ
log "๐ ========================================="
log "๐ ะะะะฃะกะ PM2 ะะะะฆะะกะกะะ"
log "๐ ========================================="

run_command "ะะฐะฟััะบ PM2 ะฟัะพัะตััะพะฒ" "pm2 start ecosystem.config.js --update-env"
log "โ PM2 ะฟัะพัะตััั ะทะฐะฟััะตะฝั"

log "๐ ะกัะฐััั PM2 ะฟัะพัะตััะพะฒ:"
pm2 list

# ะัะพะฒะตัะบะฐ ะฟัะพัะตััะพะฒ
log "๐ ========================================="
log "๐ ะะะะะะะะ ะะะะฆะะกะกะะ"
log "๐ ========================================="

log "โณ ะะถะธะดะฐะตะผ ะทะฐะฟััะบะฐ ะฟัะพัะตััะพะฒ..."
sleep 10

log "๐ ะัะพะฒะตััะตะผ backend ะฟัะพัะตัั..."
if pm2 list | grep -q "northrepublic-backend.*online"; then
    log "โ Backend ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ ัะตัะตะท PM2"
else
    log "โ ะัะธะฑะบะฐ: backend ะฝะต ะทะฐะฟััะตะฝ"
    log "๐ ะะพัะปะตะดะฝะธะต ะปะพะณะธ backend:"
    pm2 logs northrepublic-backend --lines 10 || log "โ PM2 ะปะพะณะธ ะฝะตะดะพัััะฟะฝั"
    exit 1
fi

log "๐ ะัะพะฒะตััะตะผ bot ะฟัะพัะตัั..."
if pm2 list | grep -q "northrepublic-bot.*online"; then
    log "โ Bot ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ ัะตัะตะท PM2"
else
    log "โ ะัะธะฑะบะฐ: bot ะฝะต ะทะฐะฟััะตะฝ"
    log "๐ ะะพัะปะตะดะฝะธะต ะปะพะณะธ bot:"
    pm2 logs northrepublic-bot --lines 10 || log "โ PM2 ะปะพะณะธ ะฝะตะดะพัััะฟะฝั"
    exit 1
fi

log "๐ ะัะพะฒะตััะตะผ frontend ัะฐะนะปั..."
if [ -f "index.html" ]; then
    log "โ Frontend ัะฐะนะปั ััะฟะตัะฝะพ ัะฐะทะฒะตัะฝััั"
    log "๐ ะะฐะทะผะตั index.html: $(ls -lh index.html | awk '{print $5}')"
else
    log "โ ะัะธะฑะบะฐ: frontend ัะฐะนะปั ะฝะต ะฝะฐะนะดะตะฝั"
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะดะพัััะฟะฝะพััะธ backend
log "๐ ========================================="
log "๐ ะะะะะะะะ ะะะกะขะฃะะะะกะขะ BACKEND"
log "๐ ========================================="

log "โณ ะะถะธะดะฐะตะผ ะทะฐะฟััะบะฐ backend API..."
for i in {1..30}; do
    log "๐ ะะพะฟััะบะฐ $i/30 - ะฟัะพะฒะตัะบะฐ backend API..."
    if curl -s http://localhost:3002/api/health > /dev/null 2>&1; then
        log "โ Backend API ะดะพัััะฟะตะฝ ะฝะฐ ะฟะพะฟััะบะต $i"
        break
    fi
    
    if [ $i -eq 30 ]; then
        log "โ Backend API ะฝะต ััะฐะป ะดะพัััะฟะตะฝ ะทะฐ 30 ะฟะพะฟััะพะบ"
        log "๐ ะะพะณะธ backend:"
        pm2 logs northrepublic-backend --lines 20 || log "โ PM2 ะปะพะณะธ ะฝะตะดะพัััะฟะฝั"
        exit 1
    fi
    
    sleep 2
done

# ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
log "๐ ========================================="
log "๐ ะะะะะะ ะะะะะะจะะ ะฃะกะะะจะะ!"
log "๐ ========================================="

log "๐ ะัะตะผั ะทะฐะฒะตััะตะฝะธั: $(date)"
log "๐ ะกะฐะนั ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั: https://northrepublic.me"
log "๐ก Backend API: http://localhost:3002/api/health"
log "๐ง ะะดะผะธะฝ ะฟะฐะฝะตะปั: https://northrepublic.me/admin"

log "๐ ะคะธะฝะฐะปัะฝะฐั ััะฐัะธััะธะบะฐ:"
log "๐พ ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฟะฐะผััะธ: $(free -h | grep Mem | awk '{print $3"/"$2}')"
log "๐ฝ ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะดะธัะบะฐ: $(df -h . | tail -1 | awk '{print $3"/"$2}')"

log "๐ ะะพะผะฐะฝะดั ะดะปั ะผะพะฝะธัะพัะธะฝะณะฐ:"
log "๐ ะัะพะฒะตัะธัั ะฟัะพัะตััั: pm2 list"
log "๐ ะะพะณะธ backend: pm2 logs northrepublic-backend"
log "๐ ะะพะณะธ bot: pm2 logs northrepublic-bot"

log "๐ ========================================="
log "๐ ะะะะะะ North Republic v5.2 ะะะะะะจะะ!"
log "๐ ========================================="
