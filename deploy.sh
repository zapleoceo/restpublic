#!/bin/bash

# –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bash deploy.sh (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∏–Ω–∞—é –ø–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
if [ ! -d "/var/www/northrepubli_usr/data/www/northrepublic.me" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    exit 1
fi

cd /var/www/northrepubli_usr/data/www/northrepublic.me

echo "üìç –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –û—á–∏—â–∞–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üóëÔ∏è  –û—á–∏—â–∞—é –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
git reset --hard HEAD
git clean -fd
echo "‚úÖ –°–µ—Ä–≤–µ—Ä –æ—á–∏—â–µ–Ω"

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ —Å Git
echo "üì• –û–±–Ω–æ–≤–ª—è—é –∫–æ–¥ —Å Git..."
git pull origin main
echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω —Å Git"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ backend
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ backend..."
cd backend
npm install
echo "‚úÖ Backend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –°–æ–±–∏—Ä–∞–µ–º frontend
echo "üî® –°–æ–±–∏—Ä–∞—é frontend..."
cd ../frontend
npm run build
echo "‚úÖ Frontend —Å–æ–±—Ä–∞–Ω"

# –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
echo "üìÅ –ö–æ–ø–∏—Ä—É—é –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã..."
cd ..
rm -rf static
cp -r frontend/build/static .
echo "‚úÖ Static —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"

# –ö–æ–ø–∏—Ä—É–µ–º index.html
echo "üìÑ –ö–æ–ø–∏—Ä—É—é index.html..."
cp frontend/build/index.html .
echo "‚úÖ index.html —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
pm2 restart all
echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å PM2:"
pm2 list

echo ""
echo "üéâ –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üåê –°–∞–π—Ç: https://northrepublic.me"
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–∞–π—Ç —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥"
