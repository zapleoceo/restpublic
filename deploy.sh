#!/bin/bash

# North Republic Deployment Script v5.4 - FIXED
# ะัะฟัะฐะฒะปะตะฝะฝัะน ัะบัะธะฟั ะดะตะฟะปะพั ั ะฟัะฐะฒะธะปัะฝัะผะธ ะฒัะทะพะฒะฐะผะธ ััะฝะบัะธะน
set -e  # ะััะฐะฝะพะฒะธัั ะฒัะฟะพะปะฝะตะฝะธะต ะฟัะธ ะพัะธะฑะบะต

# ะคัะฝะบัะธั ะดะปั ะปะพะณะธัะพะฒะฐะฝะธั ั ะฒัะตะผะตะฝะฝัะผะธ ะผะตัะบะฐะผะธ
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# ะคัะฝะบัะธั ะดะปั ะฒัะฟะพะปะฝะตะฝะธั ะบะพะผะฐะฝะดั ั ัะฐะนะผะฐััะพะผ
run_with_timeout() {
    local timeout=$1
    local command="$2"
    local description="$3"
    
    log "๐ ะะะงะะะะะ: $description (ัะฐะนะผะฐัั: ${timeout}s)"
    log "๐ ะะพะผะฐะฝะดะฐ: $command"
    log "โฐ ะัะตะผั ะฝะฐัะฐะปะฐ: $(date)"
    
    if timeout $timeout bash -c "$command"; then
        log "โ ะฃะกะะะจะะ: $description"
        log "โฐ ะัะตะผั ะทะฐะฒะตััะตะฝะธั: $(date)"
    else
        local exit_code=$?
        log "โ ะะจะะะะ: $description (exit code: $exit_code)"
        log "โฐ ะัะตะผั ะพัะธะฑะบะธ: $(date)"
        return $exit_code
    fi
}

# ะคัะฝะบัะธั ะดะปั ะฟัะพะฒะตัะบะธ ะธะทะผะตะฝะตะฝะธะน ะฒ package.json
has_package_changes() {
    local dir="$1"
    local package_file="$dir/package.json"
    local lock_file="$dir/package-lock.json"
    
    if [ ! -f "$package_file" ]; then
        return 1
    fi
    
    # ะัะพะฒะตััะตะผ ะธะทะผะตะฝะตะฝะธั ะฒ package.json ะธะปะธ package-lock.json
    if git diff --name-only HEAD~1 | grep -q "$package_file\|$lock_file"; then
        return 0
    fi
    
    return 1
}

# ะคัะฝะบัะธั ะดะปั ัะผะฝะพะน ัััะฐะฝะพะฒะบะธ npm ะทะฐะฒะธัะธะผะพััะตะน
smart_npm_install() {
    local dir="$1"
    local description="$2"
    
    cd "$dir"
    log "๐ ะะธัะตะบัะพัะธั: $(pwd)"
    
    if has_package_changes "$dir"; then
        log "๐ฆ ะะฑะฝะฐััะถะตะฝั ะธะทะผะตะฝะตะฝะธั ะฒ package.json - ัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ"
        run_with_timeout 120 "npm install" "$description"
    else
        log "๐ฆ ะะทะผะตะฝะตะฝะธะน ะฒ package.json ะฝะตั - ะฟัะพะฟััะบะฐะตะผ npm install"
    fi
    
    cd ..
}

log "๐ ========================================="
log "๐ ะะะงะะะะะ ะะกะะะะะะะะะซะ ะะะะะะ v5.4"
log "๐ ========================================="
log "๐ ะัะตะผั ะฝะฐัะฐะปะฐ: $(date)"
log "๐ป ะกะธััะตะผะฐ: $(uname -a)"
log "๐พ ะะฐะผััั: $(free -h | grep Mem | awk '{print $2}')"
log "๐ฝ ะะธัะบ: $(df -h . | tail -1 | awk '{print $4}') ัะฒะพะฑะพะดะฝะพ"

# ะะตัะตัะพะดะธะผ ะฒ ัะฐะฑะพััั ะดะธัะตะบัะพัะธั
cd /var/www/northrepubli_usr/data/www/northrepublic.me
log "๐ ะะฐะฑะพัะฐั ะดะธัะตะบัะพัะธั: $(pwd)"

# ะะฐัััะพะนะบะธ Git ะดะปั ััะบะพัะตะฝะธั
git config --local core.editor /bin/true
git config --local merge.tool /bin/true
export GIT_EDITOR=/bin/true
export EDITOR=/bin/true

# ะัะธะฝัะดะธัะตะปัะฝะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ ั ะฟะตัะตัะธัะฐะฝะธะตะผ ะปะพะบะฐะปัะฝัั ะธะทะผะตะฝะตะฝะธะน
log "๐ฅ ะัะธะฝัะดะธัะตะปัะฝะพ ะพะฑะฝะพะฒะปัะตะผ ะบะพะด ะธะท ัะตะฟะพะทะธัะพัะธั..."
git fetch origin main
if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/main)" ]; then
    log "๐ ะะฑะฝะฐััะถะตะฝั ะธะทะผะตะฝะตะฝะธั - ะฟัะธะฝัะดะธัะตะปัะฝะพ ะพะฑะฝะพะฒะปัะตะผ ะบะพะด"
    # ะกะฑัะฐััะฒะฐะตะผ ะฒัะต ะปะพะบะฐะปัะฝัะต ะธะทะผะตะฝะตะฝะธั ะธ ะฟัะธะฝัะดะธัะตะปัะฝะพ ะพะฑะฝะพะฒะปัะตะผ
    git reset --hard HEAD
    git clean -fd
    git pull origin main --allow-unrelated-histories --no-edit
    log "โ ะะพะด ััะฟะตัะฝะพ ะพะฑะฝะพะฒะปะตะฝ"
else
    log "โ ะะพะด ัะถะต ะฐะบััะฐะปะตะฝ - ะฟัะพะฟััะบะฐะตะผ ะพะฑะฝะพะฒะปะตะฝะธะต"
fi

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ PM2 ะฟัะพัะตััั ัะพะปัะบะพ ะตัะปะธ ะพะฝะธ ะทะฐะฟััะตะฝั
log "๐ ะัะพะฒะตััะตะผ PM2 ะฟัะพัะตััั..."
if pm2 list | grep -q "online"; then
    log "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฟััะตะฝะฝัะต PM2 ะฟัะพัะตััั"
    run_with_timeout 30 "pm2 stop all" "ะััะฐะฝะพะฒะบะฐ PM2 ะฟัะพัะตััะพะฒ"
    run_with_timeout 30 "pm2 delete all" "ะฃะดะฐะปะตะฝะธะต PM2 ะฟัะพัะตััะพะฒ"
else
    log "โ PM2 ะฟัะพัะตััั ะฝะต ะทะฐะฟััะตะฝั - ะฟัะพะฟััะบะฐะตะผ ะพััะฐะฝะพะฒะบั"
fi

# ะะฐัะฐะปะปะตะปัะฝะฐั ัะฑะพัะบะฐ Backend ะธ Bot
log "๐ง ========================================="
log "๐ง ะะะะะะะะะฌะะะฏ ะกะะะะะ BACKEND ะ BOT"
log "๐ง ========================================="

# ะะฐะฟััะบะฐะตะผ ัะฑะพัะบั backend ะฒ ัะพะฝะต
log "๐ง ะะฐะฟััะบะฐะตะผ ัะฑะพัะบั backend ะฒ ัะพะฝะต..."
(
    smart_npm_install "backend" "ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน backend"
    run_with_timeout 30 "mkdir -p ../logs" "ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ logs"
) &
BACKEND_PID=$!

# ะะฐะฟััะบะฐะตะผ ัะฑะพัะบั bot ะฒ ัะพะฝะต
log "๐ค ะะฐะฟััะบะฐะตะผ ัะฑะพัะบั bot ะฒ ัะพะฝะต..."
(
    smart_npm_install "bot" "ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน bot"
    run_with_timeout 60 "npm run build" "ะกะฑะพัะบะฐ bot"
) &
BOT_PID=$!

# ะะดะตะผ ะทะฐะฒะตััะตะฝะธั backend
log "โณ ะะถะธะดะฐะตะผ ะทะฐะฒะตััะตะฝะธั ัะฑะพัะบะธ backend..."
wait $BACKEND_PID
if [ $? -ne 0 ]; then
    log "โ ะัะธะฑะบะฐ ัะฑะพัะบะธ backend"
    exit 1
fi

# MongoDB ะผะธะณัะฐัะธั (ัะพะปัะบะพ ะตัะปะธ ะตััั ะธะทะผะตะฝะตะฝะธั ะฒ ะดะฐะฝะฝัั)
log "๐ ========================================="
log "๐ MONGODB ะะะะะะฆะะฏ"
log "๐ ========================================="

# ะัะพะฒะตััะตะผ ะธะทะผะตะฝะตะฝะธั ะฒ ัะฐะนะปะฐั ะดะฐะฝะฝัั
if git diff --name-only HEAD~1 | grep -q "lang/.*\.json\|backend/scripts/migrate-to-mongodb.js"; then
    log "๐ ะะฑะฝะฐััะถะตะฝั ะธะทะผะตะฝะตะฝะธั ะฒ ะดะฐะฝะฝัั - ะทะฐะฟััะบะฐะตะผ ะผะธะณัะฐัะธั"
    
    log "๐ ะัะพะฒะตััะตะผ ะดะพัััะฟะฝะพััั MongoDB..."
    if ! timeout 10 bash -c 'until nc -z 127.0.0.1 27017; do sleep 1; done'; then
        log "โ MongoDB ะฝะตะดะพัััะฟะฝะฐ ะฝะฐ ะฟะพััั 27017"
        exit 1
    fi
    log "โ MongoDB ะดะพัััะฟะฝะฐ ะฝะฐ ะฟะพััั 27017"
    
    # ะะฐะฟััะบะฐะตะผ ะผะธะณัะฐัะธั ั ะฟัะธะฝัะดะธัะตะปัะฝัะผ ะทะฐะฒะตััะตะฝะธะตะผ
    log "๐ ะะฐะฟััะบะฐะตะผ ะผะธะณัะฐัะธั MongoDB ั ัะฐะนะผะฐััะพะผ..."
    if timeout 30 node scripts/migrate-to-mongodb.js; then
        log "โ ะะธะณัะฐัะธั MongoDB ะทะฐะฒะตััะตะฝะฐ ััะฟะตัะฝะพ"
    else
        log "โ ะะธะณัะฐัะธั MongoDB ะทะฐะฒะตััะธะปะฐัั ั ะพัะธะฑะบะพะน ะธะปะธ ัะฐะนะผะฐััะพะผ"
        # ะัะธะฝัะดะธัะตะปัะฝะพ ะทะฐะฒะตััะฐะตะผ ะทะฐะฒะธััะธะต ะฟัะพัะตััั ะผะธะณัะฐัะธะธ
        pkill -f "migrate-to-mongodb.js" 2>/dev/null || true
        exit 1
    fi
else
    log "โ ะะทะผะตะฝะตะฝะธะน ะฒ ะดะฐะฝะฝัั ะฝะตั - ะฟัะพะฟััะบะฐะตะผ ะผะธะณัะฐัะธั"
fi

# ะะดะตะผ ะทะฐะฒะตััะตะฝะธั bot
log "โณ ะะถะธะดะฐะตะผ ะทะฐะฒะตััะตะฝะธั ัะฑะพัะบะธ bot..."
wait $BOT_PID
if [ $? -ne 0 ]; then
    log "โ ะัะธะฑะบะฐ ัะฑะพัะบะธ bot"
    exit 1
fi

# ะกะฑะพัะบะฐ Frontend (ัะฐะผะฐั ััะถะตะปะฐั ะพะฟะตัะฐัะธั)
log "๐จ ========================================="
log "๐จ ะกะะะะะ FRONTEND"
log "๐จ ========================================="

smart_npm_install "frontend" "ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน frontend"

log "๐๏ธ ะะฐะฟััะบะฐะตะผ ัะฑะพัะบั frontend..."
run_with_timeout 300 "npm run build" "ะกะฑะพัะบะฐ frontend"

log "๐ ะะพะฟะธััะตะผ ัะพะฑัะฐะฝะฝัะต ัะฐะนะปั..."
run_with_timeout 30 "cp -r dist/* ../" "ะะพะฟะธัะพะฒะฐะฝะธะต ัะฐะนะปะพะฒ frontend"

# ะะฐัััะพะนะบะฐ ะฟัะฐะฒ ะดะพัััะฟะฐ (ัะพะปัะบะพ ะดะปั ะฝะพะฒัั ัะฐะนะปะพะฒ)
log "๐ ========================================="
log "๐ ะะะกะขะะะะะ ะะะะ ะะะกะขะฃะะ"
log "๐ ========================================="

run_with_timeout 10 "chmod +x bot/dist/bot.js" "ะฃััะฐะฝะพะฒะบะฐ ะฟัะฐะฒ ะฝะฐ bot.js"

# ะะทะผะตะฝัะตะผ ะฒะปะฐะดะตะปััะฐ ัะพะปัะบะพ ะดะปั ะฝะพะฒัั ัะฐะนะปะพะฒ
log "๐ ะะทะผะตะฝัะตะผ ะฒะปะฐะดะตะปััะฐ ะดะปั ะฝะพะฒัั ัะฐะนะปะพะฒ..."
find . -newer .git/HEAD -exec chown northrepubli_usr:northrepubli_usr {} \; 2>/dev/null || true

# ะะฐะฟััะบ PM2 ะฟัะพัะตััะพะฒ
log "๐ ========================================="
log "๐ ะะะะฃะกะ PM2 ะะะะฆะะกะกะะ"
log "๐ ========================================="

run_with_timeout 60 "pm2 start ecosystem.config.js --update-env" "ะะฐะฟััะบ PM2 ะฟัะพัะตััะพะฒ"

# ะััััะฐั ะฟัะพะฒะตัะบะฐ ะฟัะพัะตััะพะฒ
log "๐ ========================================="
log "๐ ะะซะกะขะะะฏ ะะะะะะะะ ะะะะฆะะกะกะะ"
log "๐ ========================================="

log "โณ ะะถะธะดะฐะตะผ ะทะฐะฟััะบะฐ ะฟัะพัะตััะพะฒ..."
sleep 5

# ะัะพะฒะตััะตะผ ััะฐััั PM2 ะฟัะพัะตััะพะฒ
if pm2 list | grep -q "northrepublic-backend.*online" && pm2 list | grep -q "northrepublic-bot.*online"; then
    log "โ ะัะต PM2 ะฟัะพัะตััั ะทะฐะฟััะตะฝั"
else
    log "โ ะะต ะฒัะต PM2 ะฟัะพัะตััั ะทะฐะฟััะตะฝั"
    pm2 list
    exit 1
fi

# ะััััะฐั ะฟัะพะฒะตัะบะฐ backend API
log "๐ ะััััะฐั ะฟัะพะฒะตัะบะฐ backend API..."
for i in {1..10}; do
    if curl -s http://localhost:3002/api/health > /dev/null 2>&1; then
        log "โ Backend API ะดะพัััะฟะตะฝ ะฝะฐ ะฟะพะฟััะบะต $i"
        break
    fi
    
    if [ $i -eq 10 ]; then
        log "โ Backend API ะฝะต ััะฐะป ะดะพัััะฟะตะฝ ะทะฐ 10 ะฟะพะฟััะพะบ"
        pm2 logs northrepublic-backend --lines 5 || log "โ PM2 ะปะพะณะธ ะฝะตะดะพัััะฟะฝั"
        exit 1
    fi
    
    sleep 1
done

# ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
log "๐ ========================================="
log "๐ ะะกะะะะะะะะะซะ ะะะะะะ ะะะะะะจะะ!"
log "๐ ========================================="

log "๐ ะัะตะผั ะทะฐะฒะตััะตะฝะธั: $(date)"
log "๐ ะกะฐะนั ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั: https://northrepublic.me"
log "๐ก Backend API: http://localhost:3002/api/health"
log "๐ง ะะดะผะธะฝ ะฟะฐะฝะตะปั: https://northrepublic.me/admin"

log "๐ ะคะธะฝะฐะปัะฝะฐั ััะฐัะธััะธะบะฐ:"
log "๐พ ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฟะฐะผััะธ: $(free -h | grep Mem | awk '{print $3"/"$2}')"
log "๐ฝ ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะดะธัะบะฐ: $(df -h . | tail -1 | awk '{print $3"/"$2}')"

log "๐ ========================================="
log "๐ ะะกะะะะะะะะะซะ ะะะะะะ v5.4 ะะะะะะจะะ!"
log "๐ ========================================="
