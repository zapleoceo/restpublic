#!/bin/bash

# North Republic Clean Deployment Script v7.0
# –ß–∏—Å—Ç—ã–π —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –±–µ–∑ –æ–±—Ö–æ–¥–æ–≤ –ø—Ä–æ–±–ª–µ–º - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –æ—à–∏–±–∫–∏ –∫–∞–∫ –µ—Å—Ç—å
set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
run_command() {
    local command="$1"
    local description="$2"
    
    log "üöÄ –í–´–ü–û–õ–ù–Ø–ï–ú: $description"
    log "üìã –ö–æ–º–∞–Ω–¥–∞: $command"
    log "‚è∞ –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: $(date)"
    
    if eval "$command"; then
        log "‚úÖ –£–°–ü–ï–®–ù–û: $description"
        log "‚è∞ –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)"
        return 0
    else
        local exit_code=$?
        log "‚ùå –û–®–ò–ë–ö–ê: $description (exit code: $exit_code)"
        log "‚è∞ –í—Ä–µ–º—è –æ—à–∏–±–∫–∏: $(date)"
        log "üí° –ö–æ–º–∞–Ω–¥–∞, –∫–æ—Ç–æ—Ä–∞—è —É–ø–∞–ª–∞: $command"
        return $exit_code
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ package.json
has_package_changes() {
    local dir="$1"
    local package_file="$dir/package.json"
    local lock_file="$dir/package-lock.json"
    
    if [ ! -f "$package_file" ]; then
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ package.json –∏–ª–∏ package-lock.json
    if git diff --name-only HEAD~1 | grep -q "$package_file\|$lock_file"; then
        return 0
    fi
    
    return 1
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π
check_system_requirements() {
    log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è..."
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Node.js
    if ! command -v node &> /dev/null; then
        log "‚ùå Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        exit 1
    fi
    local node_version=$(node --version)
    log "‚úÖ Node.js –≤–µ—Ä—Å–∏—è: $node_version"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º npm
    if ! command -v npm &> /dev/null; then
        log "‚ùå npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        exit 1
    fi
    local npm_version=$(npm --version)
    log "‚úÖ npm –≤–µ—Ä—Å–∏—è: $npm_version"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2
    if ! command -v pm2 &> /dev/null; then
        log "‚ùå PM2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        exit 1
    fi
    local pm2_version=$(pm2 --version)
    log "‚úÖ PM2 –≤–µ—Ä—Å–∏—è: $pm_version"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º Git
    if ! command -v git &> /dev/null; then
        log "‚ùå Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        exit 1
    fi
    local git_version=$(git --version)
    log "‚úÖ $git_version"
}

log "üöÄ ========================================="
log "üöÄ CLEAN DEPLOY SCRIPT v7.0"
log "üöÄ –ë–ï–ó –û–ë–•–û–î–û–í –ü–†–û–ë–õ–ï–ú - –ü–û–ö–ê–ó–´–í–ê–ï–ú –í–°–ï –û–®–ò–ë–ö–ò"
log "üöÄ ========================================="
log "üìÖ –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: $(date)"
log "üíª –°–∏—Å—Ç–µ–º–∞: $(uname -a)"
log "üíæ –ü–∞–º—è—Ç—å: $(free -h | grep Mem | awk '{print $2}' 2>/dev/null || echo 'N/A')"
log "üíΩ –î–∏—Å–∫: $(df -h . | tail -1 | awk '{print $4}' 2>/dev/null || echo 'N/A') —Å–≤–æ–±–æ–¥–Ω–æ"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd /var/www/northrepubli_usr/data/www/northrepublic.me
log "üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
check_system_requirements

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Git
log "‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Git..."
git config --local core.editor /bin/true
git config --local merge.tool /bin/true
export GIT_EDITOR=/bin/true
export EDITOR=/bin/true

# –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º –∫–æ–º–º–∏—Ç–µ
log "üìã –¢–µ–∫—É—â–∏–π –∫–æ–º–º–∏—Ç: $(git rev-parse --short HEAD)"
log "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: $(git log -1 --oneline)"

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
log "üì• ========================================="
log "üì• –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–î–ê"
log "üì• ========================================="

run_command "git fetch origin main" "–ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"

if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/main)" ]; then
    log "üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è - –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
    log "üìã –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:"
    git log --oneline HEAD..origin/main
    
    log "üìã –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
    git diff --name-only HEAD origin/main
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º
    run_command "git reset --hard HEAD" "–°–±—Ä–æ—Å –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π"
    run_command "git clean -fd" "–û—á–∏—Å—Ç–∫–∞ –Ω–µ–æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤"
    run_command "git pull origin main --allow-unrelated-histories --no-edit" "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞"
    
    log "‚úÖ –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ –∫–æ–º–º–∏—Ç–∞: $(git rev-parse --short HEAD)"
else
    log "‚úÖ –ö–æ–¥ —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
log "üõë ========================================="
log "üõë –û–°–¢–ê–ù–û–í–ö–ê –ü–†–û–¶–ï–°–°–û–í"
log "üõë ========================================="

log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pm2 list

if pm2 list | grep -q "online"; then
    log "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã"
    run_command "pm2 stop all" "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
    run_command "pm2 delete all" "–£–¥–∞–ª–µ–Ω–∏–µ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
    
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞
    log "üõë –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞..."
    pkill -f "bot.js" 2>/dev/null || true
    pkill -f "northrepublic-bot" 2>/dev/null || true
    
    sleep 3
    log "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    log "‚úÖ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã"
fi

# –°–±–æ—Ä–∫–∞ Backend
log "üîß ========================================="
log "üîß –°–ë–û–†–ö–ê BACKEND"
log "üîß ========================================="

cd backend
log "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ package.json
if [ ! -f "package.json" ]; then
    log "‚ùå –§–∞–π–ª package.json –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ backend"
    exit 1
fi

log "üìã Backend package.json:"
cat package.json | jq '.name, .version, .scripts' 2>/dev/null || head -10 package.json

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if has_package_changes "backend"; then
    log "üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ package.json - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
    run_command "npm install" "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend"
else
    log "üì¶ –ò–∑–º–µ–Ω–µ–Ω–∏–π –≤ package.json –Ω–µ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º npm install"
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
run_command "mkdir -p ../logs" "–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ logs"

cd ..

# MongoDB –º–∏–≥—Ä–∞—Ü–∏—è
log "üîó ========================================="
log "üîó –ü–†–û–í–ï–†–ö–ê MONGODB –ò –ú–ò–ì–†–ê–¶–ò–Ø"
log "üîó ========================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MongoDB
log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å MongoDB –Ω–∞ –ø–æ—Ä—Ç—É 27018..."
if ! timeout 10 bash -c 'until nc -z 127.0.0.1 27018; do sleep 1; done'; then
    log "‚ùå MongoDB –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –ø–æ—Ä—Ç—É 27018"
    log "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ MongoDB –∑–∞–ø—É—â–µ–Ω–∞: sudo systemctl status mongod"
    exit 1
fi
log "‚úÖ MongoDB –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –ø–æ—Ä—Ç—É 27018"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–∞–Ω–Ω—ã—Ö
if git diff --name-only HEAD~1 | grep -q "lang/.*\.json\|backend/scripts/migrate-to-mongodb.js\|img/.*\.(jpg|png|gif|svg|ico)\|public/.*\.(jpg|png|gif|svg|ico)"; then
    log "üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–∞–Ω–Ω—ã—Ö - –∑–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é"
    log "üìã –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –¥–∞–Ω–Ω—ã—Ö:"
    git diff --name-only HEAD~1 | grep "lang/.*\.json\|backend/scripts/migrate-to-mongodb.js\|img/.*\.(jpg|png|gif|svg|ico)\|public/.*\.(jpg|png|gif|svg|ico)" || true
    
    run_command "timeout 60 node backend/scripts/migrate-to-mongodb.js" "–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ MongoDB"
else
    log "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é"
fi

# –°–±–æ—Ä–∫–∞ Frontend
log "üî® ========================================="
log "üî® –°–ë–û–†–ö–ê FRONTEND"
log "üî® ========================================="

cd frontend
log "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ package.json
if [ ! -f "package.json" ]; then
    log "‚ùå –§–∞–π–ª package.json –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ frontend"
    exit 1
fi

log "üìã Frontend package.json:"
cat package.json | jq '.name, .version, .scripts.build' 2>/dev/null || head -10 package.json

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
if has_package_changes "frontend"; then
    log "üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ package.json - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
    run_command "npm install" "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend"
else
    log "üì¶ –ò–∑–º–µ–Ω–µ–Ω–∏–π –≤ package.json –Ω–µ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º npm install"
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ CSS —Ñ–∞–π–ª–∞—Ö –ø–µ—Ä–µ–¥ —Å–±–æ—Ä–∫–æ–π
log "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ CSS —Ñ–∞–π–ª–∞—Ö:"
find src -name "*.css" -type f -exec echo "üìÑ {}" \; -exec wc -l {} \;

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –æ—Å–Ω–æ–≤–Ω—ã—Ö CSS —Ñ–∞–π–ª–æ–≤
log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–Ω—Ç–∞–∫—Å–∏—Å CSS —Ñ–∞–π–ª–æ–≤..."
for css_file in $(find src -name "*.css" -type f); do
    log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º: $css_file"
    if [ -f "$css_file" ]; then
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ —Ñ–∞–π–ª–∞ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        log "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å—Ç—Ä–æ–∫ —Ñ–∞–π–ª–∞ $css_file:"
        tail -5 "$css_file" | nl
        
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Å–∫–æ–±–∫–∏
        open_braces=$(grep -o '{' "$css_file" | wc -l)
        close_braces=$(grep -o '}' "$css_file" | wc -l)
        log "üìä –ë–∞–ª–∞–Ω—Å —Å–∫–æ–±–æ–∫ –≤ $css_file: –æ—Ç–∫—Ä—ã–≤–∞—é—â–∏—Ö=$open_braces, –∑–∞–∫—Ä—ã–≤–∞—é—â–∏—Ö=$close_braces"
        
        if [ "$open_braces" -ne "$close_braces" ]; then
            log "‚ùå –û–®–ò–ë–ö–ê: –î–∏—Å–±–∞–ª–∞–Ω—Å —Å–∫–æ–±–æ–∫ –≤ —Ñ–∞–π–ª–µ $css_file"
            log "üí° –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å CSS"
            exit 1
        fi
    fi
done

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É frontend
log "üèóÔ∏è –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É frontend..."
run_command "npm run build" "–°–±–æ—Ä–∫–∞ frontend"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏
if [ ! -d "dist" ]; then
    log "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è dist –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏"
    exit 1
fi

log "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ dist:"
ls -la dist/

# –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
log "üìã –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
run_command "cp -r dist/* ../" "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ frontend"

# –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
if git diff --name-only HEAD~1 | grep -q "img/.*\.(jpg|png|gif|svg|ico)\|public/.*\.(jpg|png|gif|svg|ico)"; then
    log "üìã –ö–æ–ø–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã..."
    run_command "cp -r public/img/* ../img/ 2>/dev/null || true" "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤"
fi

cd ..

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
log "üîç ========================================="
log "üîç –ü–†–û–í–ï–†–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò"
log "üîç ========================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º .env —Ñ–∞–π–ª—ã
if [ ! -f "backend/.env" ]; then
    log "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: backend/.env —Ñ–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!"
    log "üí° –°–æ–∑–¥–∞–π—Ç–µ .env —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ backend —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏"
    exit 1
fi

log "‚úÖ –§–∞–π–ª backend/.env –Ω–∞–π–¥–µ–Ω"
log "üìã –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ .env —Ñ–∞–π–ª–µ (–±–µ–∑ –∑–Ω–∞—á–µ–Ω–∏–π):"
grep -o '^[^=]*' backend/.env | head -10

# –ü—Ä–æ–≤–µ—Ä—è–µ–º ecosystem.config.js
if [ ! -f "ecosystem.config.js" ]; then
    log "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ecosystem.config.js –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

log "‚úÖ –§–∞–π–ª ecosystem.config.js –Ω–∞–π–¥–µ–Ω"
log "üìã –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PM2:"
cat ecosystem.config.js | head -20

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
log "üîê ========================================="
log "üîê –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ê–í –î–û–°–¢–£–ü–ê"
log "üîê ========================================="

# –ò–∑–º–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ñ–∞–π–ª–æ–≤
log "üîê –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ñ–∞–π–ª–æ–≤..."
run_command "find . -newer .git/HEAD -exec chown northrepubli_usr:northrepubli_usr {} \; 2>/dev/null || true" "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤"

# –ó–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
log "üöÄ ========================================="
log "üöÄ –ó–ê–ü–£–°–ö –ü–†–û–¶–ï–°–°–û–í"
log "üöÄ ========================================="

run_command "pm2 start ecosystem.config.js --update-env" "–ó–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"

# –û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
log "‚è≥ –û–∂–∏–¥–∞–µ–º —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (10 —Å–µ–∫—É–Ω–¥)..."
sleep 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
log "üîç ========================================="
log "üîç –ü–†–û–í–ï–†–ö–ê –ü–†–û–¶–ï–°–°–û–í"
log "üîç ========================================="

log "üìã –°—Ç–∞—Ç—É—Å PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
pm2 list

log "üìã –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö:"
pm2 show northrepublic-backend 2>/dev/null || log "‚ö†Ô∏è –ü—Ä–æ—Ü–µ—Å—Å northrepublic-backend –Ω–µ –Ω–∞–π–¥–µ–Ω"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ backend –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω
if pm2 list | grep -q "northrepublic-backend.*online"; then
    log "‚úÖ Backend –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    log "‚ùå Backend –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ –Ω–µ –≤ —Å—Ç–∞—Ç—É—Å–µ online"
    log "üìã –õ–æ–≥–∏ backend –ø—Ä–æ—Ü–µ—Å—Å–∞:"
    pm2 logs northrepublic-backend --lines 10 || log "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å backend API..."
for i in {1..15}; do
    if curl -s --max-time 5 http://localhost:3002/api/health > /dev/null 2>&1; then
        log "‚úÖ Backend API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ $i"
        break
    fi
    
    if [ $i -eq 15 ]; then
        log "‚ùå Backend API –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ 15 –ø–æ–ø—ã—Ç–æ–∫"
        log "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ backend:"
        pm2 logs northrepublic-backend --lines 5 || log "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏"
        exit 1
    fi
    
    log "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/15 - –æ–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫–∞ API..."
    sleep 2
done

# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
log "üéâ ========================================="
log "üéâ –î–ï–ü–õ–û–ô –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù!"
log "üéâ ========================================="

log "üìÖ –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)"
log "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://northrepublic.me"
log "üì° Backend API: http://localhost:3002/api/health"
log "üîß –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å: https://northrepublic.me/admin"

# –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
log "üìä –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
log "üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: $(free -h | grep Mem | awk '{print $3"/"$2}' 2>/dev/null || echo 'N/A')"
log "üíΩ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞: $(df -h . | tail -1 | awk '{print $3"/"$2}' 2>/dev/null || echo 'N/A')"
log "üîß PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã:"
pm2 list

log "üöÄ ========================================="
log "üöÄ CLEAN DEPLOY v7.0 –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!"
log "üöÄ –í–°–ï –ü–†–û–ë–õ–ï–ú–´ –ë–´–õ–ò –ü–û–ö–ê–ó–ê–ù–´ –ò –†–ï–®–ï–ù–´"
log "üöÄ ========================================="