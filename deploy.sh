#!/bin/bash

# ะะพะปะฝะพัะตะฝะฝัะน ัะบัะธะฟั ะดะตะฟะปะพั ะฝะฐ ัะตัะฒะตั
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: bash deploy.sh (ะฝะฐ ัะตัะฒะตัะต)

set -e  # ะััะฐะฝะพะฒะบะฐ ะฟัะธ ะพัะธะฑะบะต

echo "๐ ะะฐัะธะฝะฐั ะฟะพะปะฝัะน ะดะตะฟะปะพะน ะฝะฐ ัะตัะฒะตั..."

# ะัะพะฒะตััะตะผ, ััะพ ะผั ะฝะฐ ัะตัะฒะตัะต
if [ ! -d "/var/www/northrepubli_usr/data/www/northrepublic.me" ]; then
    echo "โ ะัะธะฑะบะฐ: ะะฐะฟัััะธัะต ัะบัะธะฟั ะฝะฐ ัะตัะฒะตัะต"
    exit 1
fi

cd /var/www/northrepubli_usr/data/www/northrepublic.me

echo "๐ ะะฐะฑะพัะฐั ะดะธัะตะบัะพัะธั: $(pwd)"

# ะัะธัะฐะตะผ ะฒัะต ะธะทะผะตะฝะตะฝะธั ะฝะฐ ัะตัะฒะตัะต
echo "๐๏ธ  ะัะธัะฐั ะฒัะต ะธะทะผะตะฝะตะฝะธั ะฝะฐ ัะตัะฒะตัะต..."
git reset --hard HEAD
git clean -fd
echo "โ ะกะตัะฒะตั ะพัะธัะตะฝ"

# ะะฑะฝะพะฒะปัะตะผ ะบะพะด ั Git
echo "๐ฅ ะะฑะฝะพะฒะปัั ะบะพะด ั Git..."
# ะะฟัะตะดะตะปัะตะผ ัะตะบัััั ะฒะตัะบั
CURRENT_BRANCH=$(git branch --show-current)
echo "๐ ะขะตะบััะฐั ะฒะตัะบะฐ: $CURRENT_BRANCH"

# ะััะฐะตะผัั ะพะฑะฝะพะฒะธัั ั main, ะตัะปะธ ะฝะต ะฟะพะปััะฐะตััั - ั master
if git pull origin main 2>/dev/null; then
    echo "โ ะะพะด ะพะฑะฝะพะฒะปะตะฝ ั main"
else
    echo "โ๏ธ ะะต ัะดะฐะปะพัั ะพะฑะฝะพะฒะธัั ั main, ะฟัะพะฑัั master..."
    if git pull origin master 2>/dev/null; then
        echo "โ ะะพะด ะพะฑะฝะพะฒะปะตะฝ ั master"
    else
        echo "โ ะัะธะฑะบะฐ ะพะฑะฝะพะฒะปะตะฝะธั ะบะพะดะฐ"
        exit 1
    fi
fi

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ backend
echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐั ะทะฐะฒะธัะธะผะพััะธ backend..."
cd backend
npm install
echo "โ Backend ะทะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั"

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ PHP (MongoDB ะดัะฐะนะฒะตั)
echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐั ะทะฐะฒะธัะธะผะพััะธ PHP..."
cd ..
if [ -f "composer.json" ]; then
    composer install --no-dev --optimize-autoloader
    echo "โ PHP ะทะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั"
    
    # ะะฝะธัะธะฐะปะธะทะธััะตะผ ะบัั ะผะตะฝั
    echo "๐ ะะฝะธัะธะฐะปะธะทะธััั ะบัั ะผะตะฝั..."
    if [ -f "php/init-cache.php" ]; then
        php php/init-cache.php
        echo "โ ะัั ะผะตะฝั ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝ"
    else
        echo "โ๏ธ init-cache.php ะฝะต ะฝะฐะนะดะตะฝ"
    fi
else
    echo "โ๏ธ composer.json ะฝะต ะฝะฐะนะดะตะฝ, ะฟัะพะฟััะบะฐั ัััะฐะฝะพะฒะบั PHP ะทะฐะฒะธัะธะผะพััะตะน"
fi

# ะะพะฟะธััะตะผ ัะพะปัะบะพ ะฝะตะพะฑัะพะดะธะผัะต ัะฐะนะปั ะฒ ะบะพัะตะฝั (ะตัะปะธ ะธั ะฝะตั)
echo "๐ ะัะพะฒะตััั ััััะบัััั ัะฐะนะปะพะฒ..."
cd ..

# ะะพะฟะธััะตะผ PHP ัะฐะนะปั ะฒ ะบะพัะตะฝั (ะดะปั ัะพะฒะผะตััะธะผะพััะธ)
if [ ! -f "index.php" ]; then
    cp php/index.php .
    echo "โ index.php ัะบะพะฟะธัะพะฒะฐะฝ ะฒ ะบะพัะตะฝั"
fi

if [ ! -f "menu.php" ]; then
    cp php/menu.php .
    echo "โ menu.php ัะบะพะฟะธัะพะฒะฐะฝ ะฒ ะบะพัะตะฝั"
fi

# ะะพะฟะธััะตะผ ะบะพะผะฟะพะฝะตะฝัั (ะตัะปะธ ะธั ะฝะตั)
if [ ! -d "components" ]; then
    cp -r php/components .
    echo "โ components ัะบะพะฟะธัะพะฒะฐะฝั"
fi

# ะะพะฟะธััะตะผ template ัะฐะนะปั (ะตัะปะธ ะธั ะฝะตั)
if [ ! -d "css" ]; then
    cp -r template/css .
    echo "โ CSS ัะบะพะฟะธัะพะฒะฐะฝั"
fi

if [ ! -d "js" ]; then
    cp -r template/js .
    echo "โ JS ัะบะพะฟะธัะพะฒะฐะฝั"
fi

if [ ! -d "images" ]; then
    cp -r template/images .
    echo "โ Images ัะบะพะฟะธัะพะฒะฐะฝั"
fi

# ะะพะฟะธััะตะผ ะธะบะพะฝะบะธ (ะตัะปะธ ะธั ะฝะตั)
if [ ! -f "apple-touch-icon.png" ]; then
    cp template/apple-touch-icon.png .
    echo "โ apple-touch-icon.png ัะบะพะฟะธัะพะฒะฐะฝ"
fi

if [ ! -f "favicon.ico" ]; then
    cp template/favicon.ico .
    echo "โ favicon.ico ัะบะพะฟะธัะพะฒะฐะฝ"
fi

echo "โ ะกัััะบัััะฐ ัะฐะนะปะพะฒ ะฟัะพะฒะตัะตะฝะฐ"

# ะะตัะตะทะฐะฟััะบะฐะตะผ ัะตัะฒะธัั
echo "๐ ะะตัะตะทะฐะฟััะบะฐั ัะตัะฒะธัั..."
pm2 restart all
echo "โ ะกะตัะฒะธัั ะฟะตัะตะทะฐะฟััะตะฝั"

# ะะพะบะฐะทัะฒะฐะตะผ ััะฐััั
echo "๐ ะกัะฐััั PM2:"
pm2 list

# ะัะพะฒะตััะตะผ ััะฐััั Git (ะฑะตะท ะบะพะผะผะธัะฐ, ัะพะณะปะฐัะฝะพ ะฟัะฐะฒะธะปะฐะผ)
echo "๐ ะกัะฐััั Git:"
git status --porcelain || echo "โ ะะฐะฑะพัะฐั ะดะธัะตะบัะพัะธั ัะธััะฐั"

# ะัะพะฒะตััะตะผ ะดะพัััะฟะฝะพััั API
echo "๐ ะัะพะฒะตััั API..."
if curl -s http://127.0.0.1:3002/api/health > /dev/null; then
    echo "โ Backend API ะดะพัััะฟะตะฝ"
else
    echo "โ๏ธ Backend API ะฝะตะดะพัััะฟะตะฝ"
fi

echo ""
echo "๐ ะะพะปะฝัะน ะดะตะฟะปะพะน ะฝะฐ ัะตัะฒะตั ะทะฐะฒะตััะตะฝ!"
echo "๐ ะกะฐะนั: https://northrepublic.me"
echo "๐ ะะต ะทะฐะฑัะดััะต ะฟะตัะตะทะฐะณััะทะธัั Nginx: sudo systemctl reload nginx"
echo "๐งช ะขะตััะธััะนัะต ัะฐะนั ัะตัะตะท 30 ัะตะบัะฝะด"
