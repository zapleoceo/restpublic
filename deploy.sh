#!/bin/bash

# North Republic Deployment Script v5.4 - FIXED
# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –≤—ã–∑–æ–≤–∞–º–∏ —Ñ—É–Ω–∫—Ü–∏–π
set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –º–µ—Ç–∫–∞–º–∏
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã —Å —Ç–∞–π–º–∞—É—Ç–æ–º
run_with_timeout() {
    local timeout=$1
    local command="$2"
    local description="$3"
    
    log "üöÄ –ù–ê–ß–ò–ù–ê–ï–ú: $description (—Ç–∞–π–º–∞—É—Ç: ${timeout}s)"
    log "üìã –ö–æ–º–∞–Ω–¥–∞: $command"
    log "‚è∞ –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: $(date)"
    
    if timeout $timeout bash -c "$command"; then
        log "‚úÖ –£–°–ü–ï–®–ù–û: $description"
        log "‚è∞ –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)"
    else
        local exit_code=$?
        log "‚ùå –û–®–ò–ë–ö–ê: $description (exit code: $exit_code)"
        log "‚è∞ –í—Ä–µ–º—è –æ—à–∏–±–∫–∏: $(date)"
        return $exit_code
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ package.json
has_package_changes() {
    local dir="$1"
    local package_file="$dir/package.json"
    local lock_file="$dir/package-lock.json"
    
    if [ ! -f "$package_file" ]; then
        return 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ package.json –∏–ª–∏ package-lock.json
    if git diff --name-only HEAD~1 | grep -q "$package_file\|$lock_file"; then
        return 0
    fi
    
    return 1
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–º–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ npm –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
smart_npm_install() {
    local dir="$1"
    local description="$2"
    
    log "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
    
    if has_package_changes "$dir"; then
        log "üì¶ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ package.json - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏"
        run_with_timeout 120 "npm install" "$description"
    else
        log "üì¶ –ò–∑–º–µ–Ω–µ–Ω–∏–π –≤ package.json –Ω–µ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º npm install"
    fi
}

log "üöÄ ========================================="
log "üöÄ –ù–ê–ß–ò–ù–ê–ï–ú –î–ï–ü–õ–û–ô –ë–ï–ó –ë–û–¢–ê v6.0"
log "üöÄ ========================================="
log "üìÖ –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞: $(date)"
log "üíª –°–∏—Å—Ç–µ–º–∞: $(uname -a)"
log "üíæ –ü–∞–º—è—Ç—å: $(free -h | grep Mem | awk '{print $2}')"
log "üíΩ –î–∏—Å–∫: $(df -h . | tail -1 | awk '{print $4}') —Å–≤–æ–±–æ–¥–Ω–æ"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd /var/www/northrepubli_usr/data/www/northrepublic.me
log "üìÅ –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Git –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è
git config --local core.editor /bin/true
git config --local merge.tool /bin/true
export GIT_EDITOR=/bin/true
export EDITOR=/bin/true

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ —Å –ø–µ—Ä–µ—Ç–∏—Ä–∞–Ω–∏–µ–º –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
log "üì• –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
git fetch origin main
if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/main)" ]; then
    log "üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥"
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º
    git reset --hard HEAD
    git clean -fd
    git pull origin main --allow-unrelated-histories --no-edit
    log "‚úÖ –ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω"
else
    log "‚úÖ –ö–æ–¥ —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
fi

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∏ –∑–∞–ø—É—â–µ–Ω—ã
log "üõë –ü—Ä–æ–≤–µ—Ä—è–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã..."
if pm2 list | grep -q "online"; then
    log "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã"
    run_with_timeout 30 "pm2 stop all" "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
    run_with_timeout 30 "pm2 delete all" "–£–¥–∞–ª–µ–Ω–∏–µ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
    
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞
    log "üõë –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –±–æ—Ç–∞..."
    pkill -f "bot.js" 2>/dev/null || true
    pkill -f "northrepublic-bot" 2>/dev/null || true
    
    # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
    log "‚è≥ –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –±–æ—Ç–∞..."
    sleep 5
else
    log "‚úÖ PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –∑–∞–ø—É—â–µ–Ω—ã - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É"
fi

# –°–±–æ—Ä–∫–∞ Backend
log "üîß ========================================="
log "üîß –°–ë–û–†–ö–ê BACKEND"
log "üîß ========================================="

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É backend
log "üîß –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É backend..."
cd backend
smart_npm_install "backend" "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π backend"
run_with_timeout 30 "mkdir -p ../logs" "–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ logs"
cd ..

# MongoDB –º–∏–≥—Ä–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–∞–Ω–Ω—ã—Ö)
log "üîó ========================================="
log "üîó MONGODB –ú–ò–ì–†–ê–¶–ò–Ø"
log "üîó ========================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö –¥–∞–Ω–Ω—ã—Ö –∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
if git diff --name-only HEAD~1 | grep -q "lang/.*\.json\|backend/scripts/migrate-to-mongodb.js\|img/.*\.(jpg|png|gif|svg|ico)\|public/.*\.(jpg|png|gif|svg|ico)"; then
    log "üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –¥–∞–Ω–Ω—ã—Ö –∏–ª–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–∞—Ö - –∑–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é"
    
    log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å MongoDB..."
    if ! timeout 10 bash -c 'until nc -z 127.0.0.1 27018; do sleep 1; done'; then
        log "‚ùå MongoDB –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –ø–æ—Ä—Ç—É 27018"
        exit 1
    fi
    log "‚úÖ MongoDB –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –ø–æ—Ä—Ç—É 27018"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º
    log "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é MongoDB —Å —Ç–∞–π–º–∞—É—Ç–æ–º..."
    if timeout 30 node backend/scripts/migrate-to-mongodb.js; then
        log "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è MongoDB –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
    else
        log "‚ùå –ú–∏–≥—Ä–∞—Ü–∏—è MongoDB –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç–æ–º"
        # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –∑–∞–≤–∏—Å—à–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –º–∏–≥—Ä–∞—Ü–∏–∏
        pkill -f "migrate-to-mongodb.js" 2>/dev/null || true
        exit 1
    fi
else
    log "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é"
fi

# –°–±–æ—Ä–∫–∞ Frontend (—Å–∞–º–∞—è —Ç—è–∂–µ–ª–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è)
log "üî® ========================================="
log "üî® –°–ë–û–†–ö–ê FRONTEND"
log "üî® ========================================="

cd frontend
smart_npm_install "frontend" "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π frontend"

log "üèóÔ∏è –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É frontend..."
run_with_timeout 300 "npm run build" "–°–±–æ—Ä–∫–∞ frontend"

log "üìã –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
run_with_timeout 30 "cp -r dist/* ../" "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ frontend"

# –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
if git diff --name-only HEAD~1 | grep -q "img/.*\.(jpg|png|gif|svg|ico)\|public/.*\.(jpg|png|gif|svg|ico)"; then
    log "üìã –ö–æ–ø–∏—Ä—É–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã..."
    run_with_timeout 30 "cp -r public/img/* ../img/ 2>/dev/null || true" "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤"
fi

cd ..

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
log "üîç ========================================="
log "üîç –ü–†–û–í–ï–†–ö–ê –û–ö–†–£–ñ–ï–ù–ò–Ø –ò –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô"
log "üîç ========================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–æ–≤
if [ ! -f "backend/.env" ]; then
    log "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: backend/.env —Ñ–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!"
    log "üìã –°–∫–æ–ø–∏—Ä—É–π—Ç–µ .env —Ñ–∞–π–ª –≤—Ä—É—á–Ω—É—é —Å –ª–æ–∫–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
log "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
if ! command -v node &> /dev/null; then
    log "‚ùå Node.js –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

if ! command -v npm &> /dev/null; then
    log "‚ùå npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

if ! command -v pm2 &> /dev/null; then
    log "‚ùå PM2 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

log "‚úÖ –í—Å–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ã"

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤)
log "üîê ========================================="
log "üîê –ù–ê–°–¢–†–û–ô–ö–ê –ü–†–ê–í –î–û–°–¢–£–ü–ê"
log "üîê ========================================="

# –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω –±–æ—Ç - –ø—Ä–∞–≤–∞ –Ω–µ –Ω—É–∂–Ω—ã
# run_with_timeout 10 "chmod +x bot/dist/bot.js" "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –Ω–∞ bot.js"

# –ò–∑–º–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤
log "üîê –ò–∑–º–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤..."
find . -newer .git/HEAD -exec chown northrepubli_usr:northrepubli_usr {} \; 2>/dev/null || true

# –ó–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
log "üöÄ ========================================="
log "üöÄ –ó–ê–ü–£–°–ö PM2 –ü–†–û–¶–ï–°–°–û–í"
log "üöÄ ========================================="

run_with_timeout 60 "pm2 start ecosystem.config.js --update-env" "–ó–∞–ø—É—Å–∫ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"

# –ü–∞—É–∑–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
log "‚è≥ –ü–∞—É–∑–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
sleep 5

# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
log "üîç ========================================="
log "üîç –ë–´–°–¢–†–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–†–û–¶–ï–°–°–û–í"
log "üîç ========================================="

log "‚è≥ –û–∂–∏–¥–∞–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
if pm2 list | grep -q "northrepublic-backend.*online"; then
    log "‚úÖ Backend –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω"
else
    log "‚ùå Backend –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω"
    pm2 list
    exit 1
fi

# –ë–æ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω –∏–∑-–∑–∞ rate limiting
log "ü§ñ Bot –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω –∏–∑-–∑–∞ rate limiting Telegram API"

# –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ backend API
log "üîç –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ backend API..."
for i in {1..10}; do
    if curl -s http://localhost:3002/api/health > /dev/null 2>&1; then
        log "‚úÖ Backend API –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ–ø—ã—Ç–∫–µ $i"
        break
    fi
    
    if [ $i -eq 10 ]; then
        log "‚ùå Backend API –Ω–µ —Å—Ç–∞–ª –¥–æ—Å—Ç—É–ø–µ–Ω –∑–∞ 10 –ø–æ–ø—ã—Ç–æ–∫"
        pm2 logs northrepublic-backend --lines 5 || log "‚ùå PM2 –ª–æ–≥–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"
        exit 1
    fi
    
    sleep 1
done

# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
log "üéâ ========================================="
log "üéâ –î–ï–ü–õ–û–ô –ë–ï–ó –ë–û–¢–ê –ó–ê–í–ï–†–®–ï–ù!"
log "üéâ ========================================="

log "üìÖ –í—Ä–µ–º—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è: $(date)"
log "üåê –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://northrepublic.me"
log "üì° Backend API: http://localhost:3002/api/health"
log "üîß –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å: https://northrepublic.me/admin"

log "üìä –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
log "üíæ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: $(free -h | grep Mem | awk '{print $3"/"$2}')"
log "üíΩ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞: $(df -h . | tail -1 | awk '{print $3"/"$2}')"

log "üöÄ ========================================="
log "üöÄ –î–ï–ü–õ–û–ô –ë–ï–ó –ë–û–¢–ê v6.0 –ó–ê–í–ï–†–®–ï–ù!"
log "üöÄ ========================================="
