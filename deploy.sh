#!/bin/bash

# North Republic Clean Deployment Script v7.0
# ะงะธัััะน ัะบัะธะฟั ะดะตะฟะปะพั ะฑะตะท ะพะฑัะพะดะพะฒ ะฟัะพะฑะปะตะผ - ะฟะพะบะฐะทัะฒะฐะตั ะฒัะต ะพัะธะฑะบะธ ะบะฐะบ ะตััั
set -e  # ะััะฐะฝะพะฒะธัั ะฒัะฟะพะปะฝะตะฝะธะต ะฟัะธ ะปัะฑะพะน ะพัะธะฑะบะต

# ะคัะฝะบัะธั ะดะปั ะปะพะณะธัะพะฒะฐะฝะธั ั ะฒัะตะผะตะฝะฝัะผะธ ะผะตัะบะฐะผะธ
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# ะคัะฝะบัะธั ะดะปั ะฒัะฟะพะปะฝะตะฝะธั ะบะพะผะฐะฝะดั ั ะฟะพะดัะพะฑะฝัะผ ะปะพะณะธัะพะฒะฐะฝะธะตะผ
run_command() {
    local command="$1"
    local description="$2"
    
    log "๐ ะะซะะะะะฏะะ: $description"
    log "๐ ะะพะผะฐะฝะดะฐ: $command"
    log "โฐ ะัะตะผั ะฝะฐัะฐะปะฐ: $(date)"
    
    if eval "$command"; then
        log "โ ะฃะกะะะจะะ: $description"
        log "โฐ ะัะตะผั ะทะฐะฒะตััะตะฝะธั: $(date)"
        return 0
    else
        local exit_code=$?
        log "โ ะะจะะะะ: $description (exit code: $exit_code)"
        log "โฐ ะัะตะผั ะพัะธะฑะบะธ: $(date)"
        log "๐ก ะะพะผะฐะฝะดะฐ, ะบะพัะพัะฐั ัะฟะฐะปะฐ: $command"
        return $exit_code
    fi
}

# ะคัะฝะบัะธั ะดะปั ะฟัะพะฒะตัะบะธ ะธะทะผะตะฝะตะฝะธะน ะฒ package.json
has_package_changes() {
    local dir="$1"
    local package_file="$dir/package.json"
    local lock_file="$dir/package-lock.json"
    
    if [ ! -f "$package_file" ]; then
        return 1
    fi
    
    # ะัะพะฒะตััะตะผ ะธะทะผะตะฝะตะฝะธั ะฒ package.json ะธะปะธ package-lock.json
    if git diff --name-only HEAD~1 | grep -q "$package_file\|$lock_file"; then
        return 0
    fi
    
    return 1
}

# ะคัะฝะบัะธั ะดะปั ะฟัะพะฒะตัะบะธ ัะธััะตะผะฝัั ััะตะฑะพะฒะฐะฝะธะน
check_system_requirements() {
    log "๐ ะัะพะฒะตััะตะผ ัะธััะตะผะฝัะต ััะตะฑะพะฒะฐะฝะธั..."
    
    # ะัะพะฒะตััะตะผ Node.js
    if ! command -v node &> /dev/null; then
        log "โ Node.js ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
        exit 1
    fi
    local node_version=$(node --version)
    log "โ Node.js ะฒะตััะธั: $node_version"
    
    # ะัะพะฒะตััะตะผ npm
    if ! command -v npm &> /dev/null; then
        log "โ npm ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
        exit 1
    fi
    local npm_version=$(npm --version)
    log "โ npm ะฒะตััะธั: $npm_version"
    
    # ะัะพะฒะตััะตะผ PM2
    if ! command -v pm2 &> /dev/null; then
        log "โ PM2 ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
        exit 1
    fi
    local pm2_version=$(pm2 --version)
    log "โ PM2 ะฒะตััะธั: $pm_version"
    
    # ะัะพะฒะตััะตะผ Git
    if ! command -v git &> /dev/null; then
        log "โ Git ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
        exit 1
    fi
    local git_version=$(git --version)
    log "โ $git_version"
}

log "๐ ========================================="
log "๐ CLEAN DEPLOY SCRIPT v7.0"
log "๐ ะะะ ะะะฅะะะะ ะะะะะะะ - ะะะะะะซะะะะ ะะกะ ะะจะะะะ"
log "๐ ========================================="
log "๐ ะัะตะผั ะฝะฐัะฐะปะฐ: $(date)"
log "๐ป ะกะธััะตะผะฐ: $(uname -a)"
log "๐พ ะะฐะผััั: $(free -h | grep Mem | awk '{print $2}' 2>/dev/null || echo 'N/A')"
log "๐ฝ ะะธัะบ: $(df -h . | tail -1 | awk '{print $4}' 2>/dev/null || echo 'N/A') ัะฒะพะฑะพะดะฝะพ"

# ะะตัะตัะพะดะธะผ ะฒ ัะฐะฑะพััั ะดะธัะตะบัะพัะธั
cd /var/www/northrepubli_usr/data/www/northrepublic.me
log "๐ ะะฐะฑะพัะฐั ะดะธัะตะบัะพัะธั: $(pwd)"

# ะัะพะฒะตััะตะผ ัะธััะตะผะฝัะต ััะตะฑะพะฒะฐะฝะธั
check_system_requirements

# ะะฐัััะพะนะบะธ Git
log "โ๏ธ ะะฐัััะฐะธะฒะฐะตะผ Git..."
git config --local core.editor /bin/true
git config --local merge.tool /bin/true
export GIT_EDITOR=/bin/true
export EDITOR=/bin/true

# ะะพะปััะฐะตะผ ะธะฝัะพัะผะฐัะธั ะพ ัะตะบััะตะผ ะบะพะผะผะธัะต
log "๐ ะขะตะบััะธะน ะบะพะผะผะธั: $(git rev-parse --short HEAD)"
log "๐ ะะพัะปะตะดะฝะธะน ะบะพะผะผะธั: $(git log -1 --oneline)"

# ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ ะธะท ัะตะฟะพะทะธัะพัะธั
log "๐ฅ ========================================="
log "๐ฅ ะะะะะะะะะะ ะะะะ"
log "๐ฅ ========================================="

run_command "git fetch origin main" "ะะพะปััะตะฝะธะต ะพะฑะฝะพะฒะปะตะฝะธะน ะธะท ัะตะฟะพะทะธัะพัะธั"

if [ "$(git rev-parse HEAD)" != "$(git rev-parse origin/main)" ]; then
    log "๐ ะะฑะฝะฐััะถะตะฝั ะธะทะผะตะฝะตะฝะธั - ะพะฑะฝะพะฒะปัะตะผ ะบะพะด"
    
    # ะะพะบะฐะทัะฒะฐะตะผ ััะพ ะธะทะผะตะฝะธะปะพัั
    log "๐ ะะทะผะตะฝะตะฝะธั ะฒ ัะตะฟะพะทะธัะพัะธะธ:"
    git log --oneline HEAD..origin/main
    
    log "๐ ะะทะผะตะฝะตะฝะฝัะต ัะฐะนะปั:"
    git diff --name-only HEAD origin/main
    
    # ะกะฑัะฐััะฒะฐะตะผ ะปะพะบะฐะปัะฝัะต ะธะทะผะตะฝะตะฝะธั ะธ ะพะฑะฝะพะฒะปัะตะผ
    run_command "git reset --hard HEAD" "ะกะฑัะพั ะปะพะบะฐะปัะฝัั ะธะทะผะตะฝะตะฝะธะน"
    run_command "git clean -fd" "ะัะธััะบะฐ ะฝะตะพััะปะตะถะธะฒะฐะตะผัั ัะฐะนะปะพะฒ"
    run_command "git pull origin main --allow-unrelated-histories --no-edit" "ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ"
    
    log "โ ะะพะด ััะฟะตัะฝะพ ะพะฑะฝะพะฒะปะตะฝ ะดะพ ะบะพะผะผะธัะฐ: $(git rev-parse --short HEAD)"
else
    log "โ ะะพะด ัะถะต ะฐะบััะฐะปะตะฝ - ะพะฑะฝะพะฒะปะตะฝะธะต ะฝะต ััะตะฑัะตััั"
fi

# ะััะฐะฝะพะฒะบะฐ PM2 ะฟัะพัะตััะพะฒ
log "๐ ========================================="
log "๐ ะะกะขะะะะะะ ะะะะฆะะกะกะะ"
log "๐ ========================================="

log "๐ ะัะพะฒะตััะตะผ ัะตะบััะธะต PM2 ะฟัะพัะตััั..."
pm2 list

if pm2 list | grep -q "online"; then
    log "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฟััะตะฝะฝัะต PM2 ะฟัะพัะตััั"
    run_command "pm2 stop all" "ะััะฐะฝะพะฒะบะฐ PM2 ะฟัะพัะตััะพะฒ"
    run_command "pm2 delete all" "ะฃะดะฐะปะตะฝะธะต PM2 ะฟัะพัะตััะพะฒ"
    
    # ะัะธะฝัะดะธัะตะปัะฝะฐั ะพััะฐะฝะพะฒะบะฐ ะฟัะพัะตััะพะฒ ะฑะพัะฐ
    log "๐ ะัะธะฝัะดะธัะตะปัะฝะพ ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะพัะตััั ะฑะพัะฐ..."
    pkill -f "bot.js" 2>/dev/null || true
    pkill -f "northrepublic-bot" 2>/dev/null || true
    
    sleep 3
    log "โ ะัะต ะฟัะพัะตััั ะพััะฐะฝะพะฒะปะตะฝั"
else
    log "โ PM2 ะฟัะพัะตััั ะฝะต ะทะฐะฟััะตะฝั"
fi

# ะกะฑะพัะบะฐ Backend
log "๐ง ========================================="
log "๐ง ะกะะะะะ BACKEND"
log "๐ง ========================================="

cd backend
log "๐ ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต package.json
if [ ! -f "package.json" ]; then
    log "โ ะคะฐะนะป package.json ะฝะต ะฝะฐะนะดะตะฝ ะฒ ะดะธัะตะบัะพัะธะธ backend"
    exit 1
fi

log "๐ Backend package.json:"
cat package.json | jq '.name, .version, .scripts' 2>/dev/null || head -10 package.json

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ ะตัะปะธ ะฝัะถะฝะพ
if has_package_changes "backend"; then
    log "๐ฆ ะะฑะฝะฐััะถะตะฝั ะธะทะผะตะฝะตะฝะธั ะฒ package.json - ัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ"
    run_command "npm install" "ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน backend"
else
    log "๐ฆ ะะทะผะตะฝะตะฝะธะน ะฒ package.json ะฝะตั - ะฟัะพะฟััะบะฐะตะผ npm install"
fi

# ะกะพะทะดะฐะตะผ ะดะธัะตะบัะพัะธั ะดะปั ะปะพะณะพะฒ
run_command "mkdir -p ../logs" "ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ logs"

cd ..

# MongoDB ะผะธะณัะฐัะธั
log "๐ ========================================="
log "๐ ะะะะะะะะ MONGODB ะ ะะะะะะฆะะฏ"
log "๐ ========================================="

# ะัะพะฒะตััะตะผ ะฟะพะดะบะปััะตะฝะธะต ะบ MongoDB
log "๐ ะัะพะฒะตััะตะผ ะดะพัััะฟะฝะพััั MongoDB ะฝะฐ ะฟะพััั 27018..."
if ! timeout 10 bash -c 'until nc -z 127.0.0.1 27018; do sleep 1; done'; then
    log "โ MongoDB ะฝะตะดะพัััะฟะฝะฐ ะฝะฐ ะฟะพััั 27018"
    log "๐ก ะัะพะฒะตัััะต ััะพ MongoDB ะทะฐะฟััะตะฝะฐ: sudo systemctl status mongod"
    exit 1
fi
log "โ MongoDB ะดะพัััะฟะฝะฐ ะฝะฐ ะฟะพััั 27018"

# ะัะพะฒะตััะตะผ ะธะทะผะตะฝะตะฝะธั ะฒ ะดะฐะฝะฝัั
if git diff --name-only HEAD~1 | grep -q "lang/.*\.json\|backend/scripts/migrate-to-mongodb.js\|img/.*\.(jpg|png|gif|svg|ico)\|public/.*\.(jpg|png|gif|svg|ico)"; then
    log "๐ ะะฑะฝะฐััะถะตะฝั ะธะทะผะตะฝะตะฝะธั ะฒ ะดะฐะฝะฝัั - ะทะฐะฟััะบะฐะตะผ ะผะธะณัะฐัะธั"
    log "๐ ะะทะผะตะฝะตะฝะฝัะต ัะฐะนะปั ะดะฐะฝะฝัั:"
    git diff --name-only HEAD~1 | grep "lang/.*\.json\|backend/scripts/migrate-to-mongodb.js\|img/.*\.(jpg|png|gif|svg|ico)\|public/.*\.(jpg|png|gif|svg|ico)" || true
    
    run_command "timeout 60 node backend/scripts/migrate-to-mongodb.js" "ะะธะณัะฐัะธั ะดะฐะฝะฝัั ะฒ MongoDB"
else
    log "โ ะะทะผะตะฝะตะฝะธะน ะฒ ะดะฐะฝะฝัั ะฝะตั - ะฟัะพะฟััะบะฐะตะผ ะผะธะณัะฐัะธั"
fi

# ะกะฑะพัะบะฐ Frontend
log "๐จ ========================================="
log "๐จ ะกะะะะะ FRONTEND"
log "๐จ ========================================="

cd frontend
log "๐ ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"

# ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต package.json
if [ ! -f "package.json" ]; then
    log "โ ะคะฐะนะป package.json ะฝะต ะฝะฐะนะดะตะฝ ะฒ ะดะธัะตะบัะพัะธะธ frontend"
    exit 1
fi

log "๐ Frontend package.json:"
cat package.json | jq '.name, .version, .scripts.build' 2>/dev/null || head -10 package.json

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ ะตัะปะธ ะฝัะถะฝะพ
if has_package_changes "frontend"; then
    log "๐ฆ ะะฑะฝะฐััะถะตะฝั ะธะทะผะตะฝะตะฝะธั ะฒ package.json - ัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ"
    run_command "npm install" "ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน frontend"
else
    log "๐ฆ ะะทะผะตะฝะตะฝะธะน ะฒ package.json ะฝะตั - ะฟัะพะฟััะบะฐะตะผ npm install"
fi

# ะะพะบะฐะทัะฒะฐะตะผ ะธะฝัะพัะผะฐัะธั ะพ CSS ัะฐะนะปะฐั ะฟะตัะตะด ัะฑะพัะบะพะน
log "๐ ะะฝัะพัะผะฐัะธั ะพ CSS ัะฐะนะปะฐั:"
find src -name "*.css" -type f -exec echo "๐ {}" \; -exec wc -l {} \;

# ะัะพะฒะตััะตะผ ัะธะฝัะฐะบัะธั ะพัะฝะพะฒะฝัั CSS ัะฐะนะปะพะฒ
log "๐ ะัะพะฒะตััะตะผ ัะธะฝัะฐะบัะธั CSS ัะฐะนะปะพะฒ..."
for css_file in $(find src -name "*.css" -type f); do
    log "๐ ะัะพะฒะตััะตะผ: $css_file"
    if [ -f "$css_file" ]; then
        # ะะพะบะฐะทัะฒะฐะตะผ ะฟะพัะปะตะดะฝะธะต ัััะพะบะธ ัะฐะนะปะฐ ะดะปั ะดะธะฐะณะฝะพััะธะบะธ
        log "๐ ะะพัะปะตะดะฝะธะต 5 ัััะพะบ ัะฐะนะปะฐ $css_file:"
        tail -5 "$css_file" | nl
        
        # ะะพะดััะธััะฒะฐะตะผ ัะบะพะฑะบะธ
        open_braces=$(grep -o '{' "$css_file" | wc -l)
        close_braces=$(grep -o '}' "$css_file" | wc -l)
        log "๐ ะะฐะปะฐะฝั ัะบะพะฑะพะบ ะฒ $css_file: ะพัะบััะฒะฐััะธั=$open_braces, ะทะฐะบััะฒะฐััะธั=$close_braces"
        
        if [ "$open_braces" -ne "$close_braces" ]; then
            log "โ ะะจะะะะ: ะะธัะฑะฐะปะฐะฝั ัะบะพะฑะพะบ ะฒ ัะฐะนะปะต $css_file"
            log "๐ก ะัะบัะพะนัะต ัะฐะนะป ะธ ะฟัะพะฒะตัััะต ัะธะฝัะฐะบัะธั CSS"
            exit 1
        fi
    fi
done

# ะะฐะฟััะบะฐะตะผ ัะฑะพัะบั frontend
log "๐๏ธ ะะฐะฟััะบะฐะตะผ ัะฑะพัะบั frontend..."
run_command "npm run build" "ะกะฑะพัะบะฐ frontend"

# ะัะพะฒะตััะตะผ ัะตะทัะปััะฐั ัะฑะพัะบะธ
if [ ! -d "dist" ]; then
    log "โ ะะธัะตะบัะพัะธั dist ะฝะต ัะพะทะดะฐะฝะฐ ะฟะพัะปะต ัะฑะพัะบะธ"
    exit 1
fi

log "๐ ะกะพะดะตัะถะธะผะพะต ะดะธัะตะบัะพัะธะธ dist:"
ls -la dist/

# ะะพะฟะธััะตะผ ัะพะฑัะฐะฝะฝัะต ัะฐะนะปั
log "๐ ะะพะฟะธััะตะผ ัะพะฑัะฐะฝะฝัะต ัะฐะนะปั..."
run_command "cp -r dist/* ../" "ะะพะฟะธัะพะฒะฐะฝะธะต ัะฐะนะปะพะฒ frontend"

# ะะพะฟะธััะตะผ ััะฐัะธัะตัะบะธะต ัะฐะนะปั ะตัะปะธ ะตััั ะธะทะผะตะฝะตะฝะธั
if git diff --name-only HEAD~1 | grep -q "img/.*\.(jpg|png|gif|svg|ico)\|public/.*\.(jpg|png|gif|svg|ico)"; then
    log "๐ ะะพะฟะธััะตะผ ะพะฑะฝะพะฒะปะตะฝะฝัะต ััะฐัะธัะตัะบะธะต ัะฐะนะปั..."
    run_command "cp -r public/img/* ../img/ 2>/dev/null || true" "ะะพะฟะธัะพะฒะฐะฝะธะต ััะฐัะธัะตัะบะธั ัะฐะนะปะพะฒ"
fi

cd ..

# ะัะพะฒะตัะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
log "๐ ========================================="
log "๐ ะะะะะะะะ ะะะะคะะะฃะะะฆะะ"
log "๐ ========================================="

# ะัะพะฒะตััะตะผ .env ัะฐะนะปั
if [ ! -f "backend/.env" ]; then
    log "โ ะะะะขะะงะะกะะะฏ ะะจะะะะ: backend/.env ัะฐะนะป ะพััััััะฒัะตั!"
    log "๐ก ะกะพะทะดะฐะนัะต .env ัะฐะนะป ะฒ ะดะธัะตะบัะพัะธะธ backend ั ะฝะตะพะฑัะพะดะธะผัะผะธ ะฟะตัะตะผะตะฝะฝัะผะธ"
    exit 1
fi

log "โ ะคะฐะนะป backend/.env ะฝะฐะนะดะตะฝ"
log "๐ ะะตัะตะผะตะฝะฝัะต ะฒ .env ัะฐะนะปะต (ะฑะตะท ะทะฝะฐัะตะฝะธะน):"
grep -o '^[^=]*' backend/.env | head -10

# ะัะพะฒะตััะตะผ ecosystem.config.js
if [ ! -f "ecosystem.config.js" ]; then
    log "โ ะะะะขะะงะะกะะะฏ ะะจะะะะ: ecosystem.config.js ะฝะต ะฝะฐะนะดะตะฝ!"
    exit 1
fi

log "โ ะคะฐะนะป ecosystem.config.js ะฝะฐะนะดะตะฝ"
log "๐ ะะพะฝัะธะณััะฐัะธั PM2:"
cat ecosystem.config.js | head -20

# ะะฐัััะพะนะบะฐ ะฟัะฐะฒ ะดะพัััะฟะฐ
log "๐ ========================================="
log "๐ ะะะกะขะะะะะ ะะะะ ะะะกะขะฃะะ"
log "๐ ========================================="

# ะะทะผะตะฝัะตะผ ะฒะปะฐะดะตะปััะฐ ัะฐะนะปะพะฒ
log "๐ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะฐะฒะธะปัะฝะพะณะพ ะฒะปะฐะดะตะปััะฐ ัะฐะนะปะพะฒ..."
run_command "find . -newer .git/HEAD -exec chown northrepubli_usr:northrepubli_usr {} \; 2>/dev/null || true" "ะะทะผะตะฝะตะฝะธะต ะฒะปะฐะดะตะปััะฐ ะฝะพะฒัั ัะฐะนะปะพะฒ"

# ะะฐะฟััะบ PM2 ะฟัะพัะตััะพะฒ
log "๐ ========================================="
log "๐ ะะะะฃะกะ ะะะะฆะะกะกะะ"
log "๐ ========================================="

run_command "pm2 start ecosystem.config.js --update-env" "ะะฐะฟััะบ PM2 ะฟัะพัะตััะพะฒ"

# ะะถะธะดะฐะฝะธะต ััะฐะฑะธะปะธะทะฐัะธะธ ะฟัะพัะตััะพะฒ
log "โณ ะะถะธะดะฐะตะผ ััะฐะฑะธะปะธะทะฐัะธะธ ะฟัะพัะตััะพะฒ (10 ัะตะบัะฝะด)..."
sleep 10

# ะัะพะฒะตัะบะฐ ััะฐัััะฐ ะฟัะพัะตััะพะฒ
log "๐ ========================================="
log "๐ ะะะะะะะะ ะะะะฆะะกะกะะ"
log "๐ ========================================="

log "๐ ะกัะฐััั PM2 ะฟัะพัะตััะพะฒ:"
pm2 list

log "๐ ะะพะดัะพะฑะฝะฐั ะธะฝัะพัะผะฐัะธั ะพ ะฟัะพัะตััะฐั:"
pm2 show northrepublic-backend 2>/dev/null || log "โ๏ธ ะัะพัะตัั northrepublic-backend ะฝะต ะฝะฐะนะดะตะฝ"

# ะัะพะฒะตััะตะผ ััะพ backend ะฟัะพัะตัั ะทะฐะฟััะตะฝ
if pm2 list | grep -q "northrepublic-backend.*online"; then
    log "โ Backend ะฟัะพัะตัั ะทะฐะฟััะตะฝ ะธ ัะฐะฑะพัะฐะตั"
else
    log "โ Backend ะฟัะพัะตัั ะฝะต ะทะฐะฟััะตะฝ ะธะปะธ ะฝะต ะฒ ััะฐัััะต online"
    log "๐ ะะพะณะธ backend ะฟัะพัะตััะฐ:"
    pm2 logs northrepublic-backend --lines 10 || log "โ ะะต ัะดะฐะปะพัั ะฟะพะปััะธัั ะปะพะณะธ"
    exit 1
fi

# ะัะพะฒะตัะบะฐ API
log "๐ ะัะพะฒะตััะตะผ ะดะพัััะฟะฝะพััั backend API..."
for i in {1..15}; do
    if curl -s --max-time 5 http://localhost:3002/api/health > /dev/null 2>&1; then
        log "โ Backend API ะดะพัััะฟะตะฝ ะฝะฐ ะฟะพะฟััะบะต $i"
        break
    fi
    
    if [ $i -eq 15 ]; then
        log "โ Backend API ะฝะต ะดะพัััะฟะตะฝ ะฟะพัะปะต 15 ะฟะพะฟััะพะบ"
        log "๐ ะะพัะปะตะดะฝะธะต ะปะพะณะธ backend:"
        pm2 logs northrepublic-backend --lines 5 || log "โ ะะต ัะดะฐะปะพัั ะฟะพะปััะธัั ะปะพะณะธ"
        exit 1
    fi
    
    log "โณ ะะพะฟััะบะฐ $i/15 - ะพะถะธะดะฐะตะผ ะทะฐะฟััะบะฐ API..."
    sleep 2
done

# ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
log "๐ ========================================="
log "๐ ะะะะะะ ะฃะกะะะจะะ ะะะะะะจะะ!"
log "๐ ========================================="

log "๐ ะัะตะผั ะทะฐะฒะตััะตะฝะธั: $(date)"
log "๐ ะกะฐะนั ะดะพัััะฟะตะฝ ะฟะพ ะฐะดัะตัั: https://northrepublic.me"
log "๐ก Backend API: http://localhost:3002/api/health"
log "๐ง ะะดะผะธะฝ ะฟะฐะฝะตะปั: https://northrepublic.me/admin"

# ะคะธะฝะฐะปัะฝะฐั ััะฐัะธััะธะบะฐ
log "๐ ะคะธะฝะฐะปัะฝะฐั ััะฐัะธััะธะบะฐ:"
log "๐พ ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะฟะฐะผััะธ: $(free -h | grep Mem | awk '{print $3"/"$2}' 2>/dev/null || echo 'N/A')"
log "๐ฝ ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะดะธัะบะฐ: $(df -h . | tail -1 | awk '{print $3"/"$2}' 2>/dev/null || echo 'N/A')"
log "๐ง PM2 ะฟัะพัะตััั:"
pm2 list

log "๐ ========================================="
log "๐ CLEAN DEPLOY v7.0 ะะะะะะจะะ ะฃะกะะะจะะ!"
log "๐ ะะกะ ะะะะะะะะซ ะะซะะ ะะะะะะะะซ ะ ะะะจะะะซ"
log "๐ ========================================="