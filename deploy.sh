#!/bin/bash

# –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: bash deploy.sh (–Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)

set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

echo "üöÄ –ù–∞—á–∏–Ω–∞—é –ø–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
if [ ! -d "/var/www/northrepubli_usr/data/www/northrepublic.me" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
    exit 1
fi

cd /var/www/northrepubli_usr/data/www/northrepublic.me

echo "üìç –†–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"

# –û—á–∏—â–∞–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üóëÔ∏è  –û—á–∏—â–∞—é –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
git reset --hard HEAD
git clean -fd
echo "‚úÖ –°–µ—Ä–≤–µ—Ä –æ—á–∏—â–µ–Ω"

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥ —Å Git
echo "üì• –û–±–Ω–æ–≤–ª—è—é –∫–æ–¥ —Å Git..."
git pull origin main
echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω —Å Git"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ backend
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ backend..."
cd backend
npm install
echo "‚úÖ Backend –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

# –°–æ–±–∏—Ä–∞–µ–º frontend
echo "üî® –°–æ–±–∏—Ä–∞—é frontend..."
cd ../frontend
npm run build
echo "‚úÖ Frontend —Å–æ–±—Ä–∞–Ω"

# –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã
echo "üìÅ –ö–æ–ø–∏—Ä—É—é –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã..."
cd ..
rm -rf static
cp -r frontend/build/static .
echo "‚úÖ Static —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º index.html –∏–∑ –∫–æ–ø–∏–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
echo "üìÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é index.html –∏–∑ –∫–æ–ø–∏–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏..."
if [ -f "index.html" ]; then
    echo "‚úÖ index.html –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –∫–æ–ø–∏–∏"
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ JS —Ñ–∞–π–ª –≤ index.html
    echo "üîÑ –û–±–Ω–æ–≤–ª—è—é —Å—Å—ã–ª–∫—É –Ω–∞ JS —Ñ–∞–π–ª –≤ index.html..."
    NEW_JS_FILE=$(ls static/js/main.*.js | head -1 | sed 's/.*\///')
    if [ -n "$NEW_JS_FILE" ]; then
        sed -i "s/main\.[a-zA-Z0-9]*\.js/$NEW_JS_FILE/g" index.html
        echo "‚úÖ –°—Å—ã–ª–∫–∞ –Ω–∞ JS —Ñ–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∞: $NEW_JS_FILE"
    else
        echo "‚ùå –û—à–∏–±–∫–∞: JS —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ static/js/"
        exit 1
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞: index.html –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏!"
    echo "üí° –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–ø–∏—é —Ä–∞–±–æ—á–µ–≥–æ index.html –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
    exit 1
fi

# –ö–æ–ø–∏—Ä—É–µ–º CSS —Ñ–∞–π–ª—ã (–∏—Å–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —à–∞–±–ª–æ–Ω–∞)
echo "üé® –ö–æ–ø–∏—Ä—É—é CSS —Ñ–∞–π–ª—ã..."
# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ CSS —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å React
rm -rf css
echo "‚úÖ –°—Ç–∞—Ä—ã–µ CSS —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã (–∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å React)"

# –ö–æ–ø–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
echo "üñºÔ∏è  –ö–æ–ø–∏—Ä—É—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è..."
cp -r frontend/public/images .
echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"

# –ö–æ–ø–∏—Ä—É–µ–º JS —Ñ–∞–π–ª—ã (–∏—Å–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —à–∞–±–ª–æ–Ω–∞)
echo "üìú –ö–æ–ø–∏—Ä—É—é JS —Ñ–∞–π–ª—ã..."
# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ JS —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç —Å React
rm -rf js
echo "‚úÖ –°—Ç–∞—Ä—ã–µ JS —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã (–∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å React)"

# –ö–æ–ø–∏—Ä—É–µ–º –∏–∫–æ–Ω–∫–∏ –∏ favicon
echo "üîó –ö–æ–ø–∏—Ä—É—é –∏–∫–æ–Ω–∫–∏ –∏ favicon..."
cp frontend/public/apple-touch-icon.png .
cp frontend/public/favicon-16x16.png .
cp frontend/public/favicon-32x32.png .
echo "‚úÖ –ò–∫–æ–Ω–∫–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é —Å–µ—Ä–≤–∏—Å—ã..."
pm2 restart all
echo "‚úÖ –°–µ—Ä–≤–∏—Å—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã"

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å PM2:"
pm2 list

# –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é index.html –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
echo "üîÑ –û–±–Ω–æ–≤–ª—è—é –ª–æ–∫–∞–ª—å–Ω—É—é –∫–æ–ø–∏—é index.html –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏..."
if [ -f "index.html" ]; then
    # –ö–æ–ø–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π index.html –æ–±—Ä–∞—Ç–Ω–æ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
    cp index.html ../index.html
    echo "‚úÖ –õ–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ø–∏—è index.html –æ–±–Ω–æ–≤–ª–µ–Ω–∞"
    
    # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
    cd ..
    git add index.html
    git commit -m "Update: index.html with new JS file reference ($NEW_JS_FILE)" || echo "‚ö†Ô∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
    git push origin main
    echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
    cd /var/www/northrepubli_usr/data/www/northrepublic.me
else
    echo "‚ùå –û—à–∏–±–∫–∞: index.html –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è"
fi

echo ""
echo "üéâ –ü–æ–ª–Ω—ã–π –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω!"
echo "üåê –°–∞–π—Ç: https://northrepublic.me"
echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–∞–π—Ç —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥"
