<?php
// –°–∫—Ä–∏–ø—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤ —Å–æ–±—ã—Ç–∏–π –≤ MongoDB
// –†–∞–∑–º–µ—â–µ–Ω –≤ admin/database –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if (file_exists(__DIR__ . '/../../.env')) {
    $lines = file(__DIR__ . '/../../.env', FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    foreach ($lines as $line) {
        if (strpos($line, '=') !== false && strpos($line, '#') !== 0) {
            list($key, $value) = explode('=', $line, 2);
            $_ENV[trim($key)] = trim($value);
        }
    }
}

// –°–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–ª—è —Å–æ–±—ã—Ç–∏–π
$translations = [
    'en' => [
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π
        'üé≠ –ú–∞—Ñ–∏—è' => 'üé≠ Mafia',
        '–î–µ–≥—É—Å—Ç–∞—Ü–∏—è –≤–∏–Ω' => 'Wine Tasting',
        '–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –±–∞–Ω–∫–µ—Ç' => 'New Year Banquet',
        '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å –ø–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—é –ø–∞—Å—Ç—ã' => 'Pasta Cooking Master Class',
        '–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —É–∂–∏–Ω –Ω–∞ –î–µ–Ω—å –°–≤—è—Ç–æ–≥–æ –í–∞–ª–µ–Ω—Ç–∏–Ω–∞' => 'Romantic Valentine\'s Day Dinner',
        '–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞' => 'Restaurant Birthday',
        
        // –û–ø–∏—Å–∞–Ω–∏—è
        '–í–µ—á–µ—Ä–Ω—è—è –∏–≥—Ä–∞ –≤ –º–∞—Ñ–∏—é —Å –¥—Ä—É–∑—å—è–º–∏' => 'Evening mafia game with friends',
        '–î–µ–≥—É—Å—Ç–∞—Ü–∏—è –ª—É—á—à–∏—Ö –≤–∏–Ω —Å —Å–æ–º–µ–ª—å–µ' => 'Tasting of the best wines with sommelier',
        '–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –±–∞–Ω–∫–µ—Ç —Å –∂–∏–≤–æ–π –º—É–∑—ã–∫–æ–π' => 'Holiday banquet with live music',
        '–£—á–∏–º—Å—è –≥–æ—Ç–æ–≤–∏—Ç—å –Ω–∞—Å—Ç–æ—è—â—É—é –∏—Ç–∞–ª—å—è–Ω—Å–∫—É—é –ø–∞—Å—Ç—É' => 'Learn to cook authentic Italian pasta',
        '–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –º–µ–Ω—é –¥–ª—è –≤–ª—é–±–ª–µ–Ω–Ω—ã—Ö' => 'Special romantic menu for lovers',
        '–ü—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–µ –≥–æ–¥–æ–≤—â–∏–Ω—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞' => 'Restaurant anniversary celebration',
        
        // –£—Å–ª–æ–≤–∏—è
        '1500 —Ä—É–±. —Å —á–µ–ª–æ–≤–µ–∫–∞' => '1500 rubles per person',
        '3000 —Ä—É–±. —Å —á–µ–ª–æ–≤–µ–∫–∞, –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å' => '3000 rubles per person, advance booking required',
        '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 2000 —Ä—É–±.' => 'Free with order from 2000 rubles',
        '2500 —Ä—É–±. –∑–∞ –ø–∞—Ä—É, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –º–µ–Ω—é' => '2500 rubles per couple, special menu',
        '–í—Ö–æ–¥ —Å–≤–æ–±–æ–¥–Ω—ã–π, —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è' => 'Free entry, special offers',
        '–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞' => 'Advance booking required',
        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ' => 'Limited seating available'
    ],
    'vi' => [
        // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Å–æ–±—ã—Ç–∏–π
        'üé≠ –ú–∞—Ñ–∏—è' => 'üé≠ Mafia',
        '–î–µ–≥—É—Å—Ç–∞—Ü–∏—è –≤–∏–Ω' => 'N·∫øm th·ª≠ r∆∞·ª£u vang',
        '–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –±–∞–Ω–∫–µ—Ç' => 'Ti·ªác t·∫•t ni√™n',
        '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å –ø–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—é –ø–∞—Å—Ç—ã' => 'L·ªõp h·ªçc n·∫•u m√¨ √ù',
        '–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —É–∂–∏–Ω –Ω–∞ –î–µ–Ω—å –°–≤—è—Ç–æ–≥–æ –í–∞–ª–µ–Ω—Ç–∏–Ω–∞' => 'B·ªØa t·ªëi l√£ng m·∫°n ng√†y Valentine',
        '–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞' => 'Sinh nh·∫≠t nh√† h√†ng',
        
        // –û–ø–∏—Å–∞–Ω–∏—è
        '–í–µ—á–µ—Ä–Ω—è—è –∏–≥—Ä–∞ –≤ –º–∞—Ñ–∏—é —Å –¥—Ä—É–∑—å—è–º–∏' => 'Tr√≤ ch∆°i mafia bu·ªïi t·ªëi v·ªõi b·∫°n b√®',
        '–î–µ–≥—É—Å—Ç–∞—Ü–∏—è –ª—É—á—à–∏—Ö –≤–∏–Ω —Å —Å–æ–º–µ–ª—å–µ' => 'N·∫øm th·ª≠ nh·ªØng lo·∫°i r∆∞·ª£u vang ngon nh·∫•t v·ªõi chuy√™n gia r∆∞·ª£u',
        '–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –±–∞–Ω–∫–µ—Ç —Å –∂–∏–≤–æ–π –º—É–∑—ã–∫–æ–π' => 'Ti·ªác t·∫•t ni√™n v·ªõi nh·∫°c s·ªëng',
        '–£—á–∏–º—Å—è –≥–æ—Ç–æ–≤–∏—Ç—å –Ω–∞—Å—Ç–æ—è—â—É—é –∏—Ç–∞–ª—å—è–Ω—Å–∫—É—é –ø–∞—Å—Ç—É' => 'H·ªçc n·∫•u m√¨ √ù ch√≠nh th·ªëng',
        '–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –º–µ–Ω—é –¥–ª—è –≤–ª—é–±–ª–µ–Ω–Ω—ã—Ö' => 'Th·ª±c ƒë∆°n l√£ng m·∫°n ƒë·∫∑c bi·ªát cho c√°c c·∫∑p ƒë√¥i',
        '–ü—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–µ –≥–æ–¥–æ–≤—â–∏–Ω—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞' => 'L·ªÖ k·ª∑ ni·ªám ng√†y th√†nh l·∫≠p nh√† h√†ng',
        
        // –£—Å–ª–æ–≤–∏—è
        '1500 —Ä—É–±. —Å —á–µ–ª–æ–≤–µ–∫–∞' => '1500 r√∫p m·ªói ng∆∞·ªùi',
        '3000 —Ä—É–±. —Å —á–µ–ª–æ–≤–µ–∫–∞, –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å' => '3000 r√∫p m·ªói ng∆∞·ªùi, c·∫ßn ƒë·∫∑t tr∆∞·ªõc',
        '–ë–µ—Å–ø–ª–∞—Ç–Ω–æ –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 2000 —Ä—É–±.' => 'Mi·ªÖn ph√≠ khi ƒë·∫∑t t·ª´ 2000 r√∫p',
        '2500 —Ä—É–±. –∑–∞ –ø–∞—Ä—É, —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –º–µ–Ω—é' => '2500 r√∫p cho c·∫∑p ƒë√¥i, th·ª±c ƒë∆°n ƒë·∫∑c bi·ªát',
        '–í—Ö–æ–¥ —Å–≤–æ–±–æ–¥–Ω—ã–π, —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è' => 'V√†o c·ª≠a mi·ªÖn ph√≠, ∆∞u ƒë√£i ƒë·∫∑c bi·ªát',
        '–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–ø–∏—Å—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞' => 'B·∫Øt bu·ªôc ƒë·∫∑t tr∆∞·ªõc',
        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ' => 'S·ªë ch·ªó ng·ªìi c√≥ h·∫°n'
    ]
];

try {
    $mongodbUrl = $_ENV['MONGODB_URL'] ?? 'mongodb://localhost:27018';
    $dbName = $_ENV['MONGODB_DB_NAME'] ?? 'northrepublic';
    
    $client = new MongoDB\Client($mongodbUrl);
    $db = $client->$dbName;
    $eventsCollection = $db->events;
    
    echo "üîç –ü–æ–∏—Å–∫ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞...\n";
    
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–æ–±—ã—Ç–∏—è
    $events = $eventsCollection->find([])->toArray();
    echo "üìä –ù–∞–π–¥–µ–Ω–æ —Å–æ–±—ã—Ç–∏–π: " . count($events) . "\n\n";
    
    $updatedCount = 0;
    
    foreach ($events as $event) {
        echo "üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è ID: " . $event['_id'] . "\n";
        
        $updateData = [];
        $hasUpdates = false;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        if (isset($event['title']) && !empty($event['title'])) {
            $titleRu = $event['title'];
            
            // –ê–Ω–≥–ª–∏–π—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
            if (!isset($event['title_en']) || empty($event['title_en']) || $event['title_en'] === $titleRu) {
                $titleEn = translateText($titleRu, 'en', $translations);
                if ($titleEn !== $titleRu) {
                    $updateData['title_ru'] = $titleRu;
                    $updateData['title_en'] = $titleEn;
                    $hasUpdates = true;
                    echo "  ‚úÖ EN Title: " . $titleEn . "\n";
                }
            }
            
            // –í—å–µ—Ç–Ω–∞–º—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
            if (!isset($event['title_vi']) || empty($event['title_vi']) || $event['title_vi'] === $titleRu) {
                $titleVi = translateText($titleRu, 'vi', $translations);
                if ($titleVi !== $titleRu) {
                    $updateData['title_vi'] = $titleVi;
                    $hasUpdates = true;
                    echo "  ‚úÖ VI Title: " . $titleVi . "\n";
                }
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–µ—Ä–µ–≤–æ–¥–∏–º —É—Å–ª–æ–≤–∏—è
        if (isset($event['conditions']) && !empty($event['conditions'])) {
            $conditionsRu = $event['conditions'];
            
            // –ê–Ω–≥–ª–∏–π—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
            if (!isset($event['conditions_en']) || empty($event['conditions_en']) || $event['conditions_en'] === $conditionsRu) {
                $conditionsEn = translateText($conditionsRu, 'en', $translations);
                if ($conditionsEn !== $conditionsRu) {
                    $updateData['conditions_ru'] = $conditionsRu;
                    $updateData['conditions_en'] = $conditionsEn;
                    $hasUpdates = true;
                    echo "  ‚úÖ EN Conditions: " . $conditionsEn . "\n";
                }
            }
            
            // –í—å–µ—Ç–Ω–∞–º—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥
            if (!isset($event['conditions_vi']) || empty($event['conditions_vi']) || $event['conditions_vi'] === $conditionsRu) {
                $conditionsVi = translateText($conditionsRu, 'vi', $translations);
                if ($conditionsVi !== $conditionsRu) {
                    $updateData['conditions_vi'] = $conditionsVi;
                    $hasUpdates = true;
                    echo "  ‚úÖ VI Conditions: " . $conditionsVi . "\n";
                }
            }
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
        if (isset($event['title']) && !empty($event['title'])) {
            $descriptions = [
                '–î–µ–≥—É—Å—Ç–∞—Ü–∏—è –≤–∏–Ω' => '–î–µ–≥—É—Å—Ç–∞—Ü–∏—è –ª—É—á—à–∏—Ö –≤–∏–Ω —Å —Å–æ–º–µ–ª—å–µ',
                '–ù–æ–≤–æ–≥–æ–¥–Ω–∏–π –±–∞–Ω–∫–µ—Ç' => '–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π –±–∞–Ω–∫–µ—Ç —Å –∂–∏–≤–æ–π –º—É–∑—ã–∫–æ–π',
                '–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å –ø–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—é –ø–∞—Å—Ç—ã' => '–£—á–∏–º—Å—è –≥–æ—Ç–æ–≤–∏—Ç—å –Ω–∞—Å—Ç–æ—è—â—É—é –∏—Ç–∞–ª—å—è–Ω—Å–∫—É—é –ø–∞—Å—Ç—É',
                '–†–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π —É–∂–∏–Ω –Ω–∞ –î–µ–Ω—å –°–≤—è—Ç–æ–≥–æ –í–∞–ª–µ–Ω—Ç–∏–Ω–∞' => '–°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–æ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ –º–µ–Ω—é –¥–ª—è –≤–ª—é–±–ª–µ–Ω–Ω—ã—Ö',
                '–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞' => '–ü—Ä–∞–∑–¥–Ω–æ–≤–∞–Ω–∏–µ –≥–æ–¥–æ–≤—â–∏–Ω—ã —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞'
            ];
            
            $descriptionRu = $descriptions[$event['title']] ?? '–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è';
            
            // –ê–Ω–≥–ª–∏–π—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –æ–ø–∏—Å–∞–Ω–∏—è
            if (!isset($event['description_en']) || empty($event['description_en'])) {
                $descriptionEn = translateText($descriptionRu, 'en', $translations);
                $updateData['description_ru'] = $descriptionRu;
                $updateData['description_en'] = $descriptionEn;
                $hasUpdates = true;
                echo "  ‚úÖ EN Description: " . $descriptionEn . "\n";
            }
            
            // –í—å–µ—Ç–Ω–∞–º—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥ –æ–ø–∏—Å–∞–Ω–∏—è
            if (!isset($event['description_vi']) || empty($event['description_vi'])) {
                $descriptionVi = translateText($descriptionRu, 'vi', $translations);
                $updateData['description_vi'] = $descriptionVi;
                $hasUpdates = true;
                echo "  ‚úÖ VI Description: " . $descriptionVi . "\n";
            }
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç, –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if ($hasUpdates) {
            $updateData['updated_at'] = new MongoDB\BSON\UTCDateTime();
            
            $result = $eventsCollection->updateOne(
                ['_id' => $event['_id']],
                ['$set' => $updateData]
            );
            
            if ($result->getModifiedCount() > 0) {
                $updatedCount++;
                echo "  üíæ –°–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö\n";
            } else {
                echo "  ‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ–±—ã—Ç–∏—è\n";
            }
        } else {
            echo "  ‚ÑπÔ∏è –ü–µ—Ä–µ–≤–æ–¥—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –∏–ª–∏ –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è\n";
        }
        
        echo "\n";
    }
    
    echo "üéâ –ü–µ—Ä–µ–≤–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω!\n";
    echo "üìà –û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–æ–±—ã—Ç–∏–π: " . $updatedCount . " –∏–∑ " . count($events) . "\n";
    
} catch (Exception $e) {
    echo "‚ùå –û—à–∏–±–∫–∞: " . $e->getMessage() . "\n";
}

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞
 */
function translateText($text, $targetLanguage, $translations) {
    if (!isset($translations[$targetLanguage])) {
        return $text;
    }
    
    $translatedText = $text;
    foreach ($translations[$targetLanguage] as $ru => $translated) {
        $translatedText = str_replace($ru, $translated, $translatedText);
    }
    
    return $translatedText;
}
?>
